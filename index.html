<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業技術積分申報系統</title>
    <!-- 使用 Tailwind CSS 提升視覺質感 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f3f4f6; }
        .category-card:hover { border-color: #3b82f6; }
        .score-badge { transition: all 0.3s ease; }
        .highest-tag { background-color: #ef4444; color: white; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
    </style>
</head>
<body class="pb-20">

    <!-- Header -->
    <nav class="bg-blue-700 text-white shadow-lg p-4 mb-8">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fa-solid fa-shield-halved mr-2"></i>專業技術能力積分申報</h1>
            <span class="text-sm opacity-80">台北市政府消防局標準</span>
        </div>
    </nav>

    <div class="container mx-auto px-4 max-w-4xl">
        
        <!-- 規則說明區 -->
        <div class="bg-white border-l-4 border-blue-500 p-4 mb-6 shadow-sm rounded-r-lg">
            <h2 class="font-bold text-blue-800 mb-2"><i class="fa-solid fa-circle-info mr-2"></i>計分規則說明</h2>
            <ul class="text-sm text-gray-600 space-y-1">
                <li>1. 系統劃分為四大類別，<span class="text-red-600 font-bold">每一類別僅採計該區分數最高之一項</span>。</li>
                <li>2. 證照必須在<span class="text-red-600 font-bold">有效期限內</span>方可計分。</li>
                <li>3. 勾選項目後請務必上傳對應證件影本 (PDF/JPG)。</li>
            </ul>
        </div>

        <!-- 個人資訊 -->
        <div class="bg-white p-6 rounded-xl shadow-md mb-8 grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700">身分證字號</label>
                <input type="text" id="idCard" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2 border" placeholder="E123456789">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">姓名</label>
                <input type="text" id="name" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2 border" placeholder="王小明">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">服務單位</label>
                <input type="text" id="unit" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 p-2 border" placeholder="秘書室">
            </div>
        </div>

        <!-- 證照填寫區 -->
        <div id="formContainer" class="space-y-6">
            <!-- 類別卡片模板會由 JS 動態生成 -->
        </div>

        <!-- 底部統計列 -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-2xl p-4 z-50">
            <div class="container mx-auto max-w-4xl flex justify-between items-center">
                <div class="flex flex-col">
                    <span class="text-gray-500 text-sm">預計獲得積分</span>
                    <span class="text-3xl font-bold text-blue-600" id="totalScoreDisplay">0.00</span>
                </div>
                <button onclick="submitForm()" id="submitBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full shadow-lg transition-transform active:scale-95">
                    確認送出申報
                </button>
            </div>
        </div>

    </div>

    <!-- 成功與錯誤提示 -->
    <div id="toast" class="fixed top-5 right-5 hidden z-50 p-4 rounded-lg shadow-xl text-white font-bold"></div>

    <script>
        const GAS_URL = "你的GAS佈署網址"; // <--- 請替換

        // 證照邏輯結構
        const config = [
            {
                id: "water",
                title: "水上救生",
                items: [
                    { id: "water_1", name: "救生員", score: 0.35 },
                    { id: "water_2", name: "救生教練", score: 0.56 }
                ]
            },
            {
                id: "swift",
                title: "急流救援",
                items: [
                    { id: "swift_1", name: "急流救援訓練(40H)", score: 0.56 },
                    { id: "swift_2", name: "急流救援教官班(45H)", score: 0.70 }
                ]
            },
            {
                id: "dive",
                title: "潛水救援",
                items: [
                    { id: "dive_1", name: "救援潛水", score: 0.56 },
                    { id: "dive_2", name: "潛水教官", score: 0.70 },
                    { id: "dive_3", name: "公共安全潛水(82H)", score: 0.70 }
                ]
            },
            {
                id: "drive",
                title: "車輛駕駛",
                items: [
                    { id: "drive_1", name: "大貨(客)車駕照", score: 0.70 },
                    { id: "drive_2", name: "聯結車駕照", score: 1.05 }
                ]
            }
        ];

        // 動態生成 HTML
        function renderForm() {
            const container = document.getElementById('formContainer');
            config.forEach(cat => {
                let html = `
                    <div class="bg-white rounded-xl shadow-md overflow-hidden category-card border-2 border-transparent transition-all">
                        <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                            <h3 class="font-bold text-gray-700">${cat.title}</h3>
                            <span class="text-xs text-blue-500 bg-blue-50 px-2 py-1 rounded">最高取一項</span>
                        </div>
                        <div class="p-6 space-y-6">
                `;
                cat.items.forEach(item => {
                    html += `
                        <div class="certificate-item" data-cat="${cat.id}" data-score="${item.score}" data-name="${item.name}">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div class="flex items-center space-x-3">
                                    <input type="checkbox" onchange="updateUI()" class="w-5 h-5 text-blue-600 rounded focus:ring-blue-500 cert-checkbox">
                                    <span class="font-medium text-gray-800">${item.name} <span class="text-blue-500 ml-1">(${item.score}分)</span></span>
                                    <span class="highest-badge hidden"></span>
                                </div>
                                <div class="flex flex-col sm:flex-row gap-2 items-center text-sm">
                                    <div class="flex items-center">
                                        <label class="mr-2 text-gray-500">到期日:</label>
                                        <input type="date" onchange="updateUI()" class="border rounded p-1 text-gray-700 cert-date">
                                    </div>
                                    <input type="file" onchange="updateUI()" class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cert-file">
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            });
        }

        // 更新 UI、檢查日期、計算分數
        function updateUI() {
            let totalScore = 0;
            const today = new Date();

            config.forEach(cat => {
                let catMax = 0;
                let bestItem = null;

                // 找出該區塊勾選且「有效」且「分數最高」的
                const items = document.querySelectorAll(`.certificate-item[data-cat="${cat.id}"]`);
                items.forEach(el => {
                    const checkbox = el.querySelector('.cert-checkbox');
                    const dateInput = el.querySelector('.cert-date');
                    const badge = el.querySelector('.highest-badge');
                    const score = parseFloat(el.dataset.score);
                    
                    badge.classList.add('hidden'); // 先隱藏
                    
                    if (checkbox.checked) {
                        const expiryDate = new Date(dateInput.value);
                        // 日期檢查邏輯
                        if (!dateInput.value) {
                            checkbox.parentElement.classList.add('text-orange-500');
                        } else if (expiryDate < today) {
                            checkbox.parentElement.classList.add('text-red-500');
                            checkbox.parentElement.classList.remove('text-orange-500');
                            return; // 過期不計分
                        } else {
                            checkbox.parentElement.classList.remove('text-red-500', 'text-orange-500');
                            if (score > catMax) {
                                catMax = score;
                                bestItem = badge;
                            }
                        }
                    }
                });

                if (bestItem) {
                    bestItem.innerHTML = `<span class="highest-tag">最高分採計</span>`;
                    bestItem.classList.remove('hidden');
                }
                totalScore += catMax;
            });

            document.getElementById('totalScoreDisplay').innerText = totalScore.toFixed(2);
        }

        async function submitForm() {
            const btn = document.getElementById('submitBtn');
            const idCard = document.getElementById('idCard').value;
            const name = document.getElementById('name').value;
            if(!idCard || !name) return showToast("請填寫基本資料", "error");

            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>上傳中...';

            const payload = {
                idCard, name, unit: document.getElementById('unit').value,
                certificates: []
            };

            const checkedItems = document.querySelectorAll('.cert-checkbox:checked');
            
            for(let check of checkedItems) {
                const parent = check.closest('.certificate-item');
                const fileInput = parent.querySelector('.cert-file');
                const dateVal = parent.querySelector('.cert-date').value;
                
                if(!dateVal || !fileInput.files[0]) {
                    showToast(`請檢查 ${parent.dataset.name} 的日期與檔案`, "error");
                    btn.disabled = false;
                    btn.innerText = '確認送出申報';
                    return;
                }

                const fileBase64 = await toBase64(fileInput.files[0]);
                payload.certificates.push({
                    category: parent.dataset.cat,
                    itemName: parent.dataset.name,
                    score: parent.dataset.score,
                    expiryDate: dateVal,
                    fileName: fileInput.files[0].name,
                    fileBase64: fileBase64
                });
            }

            if(payload.certificates.length === 0) {
                showToast("請至少選擇一項證照", "error");
                btn.disabled = false;
                btn.innerText = '確認送出申報';
                return;
            }

            try {
                const resp = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                const result = await resp.json();
                if(result.result === 'success') {
                    showToast("申報成功！頁面將重整", "success");
                    setTimeout(() => location.reload(), 2000);
                }
            } catch(e) {
                showToast("上傳失敗，請稍後再試", "error");
                btn.disabled = false;
                btn.innerText = '確認送出申報';
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
        });

        function showToast(msg, type) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = `fixed top-5 right-5 z-50 p-4 rounded-lg shadow-xl text-white font-bold block ${type==='success'?'bg-green-500':'bg-red-500'}`;
            setTimeout(() => t.classList.add('hidden'), 3000);
        }

        renderForm();
    </script>
</body>
</html>
