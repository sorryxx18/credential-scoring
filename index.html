<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‡ºåŒ—å¸‚æ¶ˆé˜²å±€è¨“ç·´ä¸­å¿ƒè­‰ç…§ç©åˆ†çµ±è¨ˆç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.4); }
        .item-row { transition: all 0.2s ease; border: 2px solid #f1f5f9; }
        .highest-glow { border-color: #2563eb !important; background: #eff6ff; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15); }
        .no-cert-active { border-color: #cbd5e1 !important; background: #f1f5f9; opacity: 0.7; }
        .select-custom { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; }
        
        @keyframes stamp {
            0% { transform: scale(3); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .stamp-effect { animation: stamp 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @media (max-width: 640px) {
            .p-10 { padding: 1.25rem !important; }
            .p-8 { padding: 1rem !important; }
            .cert-file { width: 100% !important; margin-top: 0.5rem; }
        }
    </style>
</head>
<body class="p-2 md:p-10 text-slate-800">

    <div id="mainApp" class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-6">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-4 rounded-3xl shadow-xl text-white">
                    <i class="fa-solid fa-fire-extinguisher text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-black tracking-tight">è‡ºåŒ—å¸‚æ¶ˆé˜²å±€è¨“ç·´ä¸­å¿ƒç©åˆ†è­‰ç…§çµ±è¨ˆç³»çµ±</h1>
                    <p class="text-slate-500 font-bold italic underline decoration-blue-500 underline-offset-4 uppercase text-[10px]">Promotion Scoring Standard</p>
                </div>
            </div>
            <div class="bg-white px-6 py-2 rounded-2xl shadow-sm border border-slate-200 text-center">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1 italic">Bureau Info</p>
                <p class="text-blue-700 font-black">è‡ºåŒ—å¸‚æ”¿åºœæ¶ˆé˜²å±€è¨“ç·´ä¸­å¿ƒ</p>
            </div>
        </header>

        <!-- å¡«å ±èªªæ˜å¡ -->
        <div class="glass-card p-6 md:p-8 mb-8 border-l-8 border-blue-600 shadow-sm relative overflow-hidden">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4">
                <h2 class="text-xl font-bold text-slate-800 flex items-center">
                    <i class="fa-solid fa-circle-info text-blue-600 mr-2"></i> å¡«å ±é ˆçŸ¥èˆ‡è¨ˆåˆ†è¦å®š
                </h2>
                <a href="mailto:aa9798@gov.taipei" class="bg-blue-50 text-blue-700 px-4 py-2 rounded-full text-xs font-black flex items-center hover:bg-blue-100 transition">
                    <i class="fa-solid fa-envelope-open-text mr-2"></i> æœ‰ç–‘å•ï¼Ÿè¯ç¹«æ‰¿è¾¦äºº
                </a>
            </div>
            <div class="grid md:grid-cols-2 gap-x-12 gap-y-4 text-sm text-slate-600 leading-relaxed font-medium">
                <div class="space-y-3">
                    <p class="flex items-start gap-2"><i class="fa-solid fa-star text-amber-500 mt-1"></i><span><strong>æ“‡å„ªæ¡è¨ˆï¼š</strong> åŒä¸€é¡åˆ¥åƒ…æ¡è¨ˆ<strong>åˆ†æ•¸æœ€é«˜</strong>çš„ä¸€é …ã€‚</span></p>
                    <p class="flex items-start gap-2"><i class="fa-solid fa-calendar-check text-blue-500 mt-1"></i><span><strong>æ•ˆæœŸåˆ¤å®šï¼š</strong> æ•‘ç”Ÿå“¡éœ€å¡«åˆ°æœŸæ—¥ã€‚éæœŸè¨ˆç‚º 0 åˆ†ã€‚</span></p>
                </div>
                <div class="space-y-3">
                    <p class="flex items-start gap-2"><i class="fa-solid fa-file-arrow-up text-red-500 mt-1"></i><span><strong>é™„ä»¶å¿…è¦ï¼š</strong> å‹¾é¸é …ç›®å¾Œå¿…é ˆä¸Šå‚³æª”æ¡ˆï¼Œå¦å‰‡ç„¡æ³•é€å‡ºã€‚</span></p>
                    <p class="flex items-start gap-2"><i class="fa-solid fa-user-shield text-emerald-500 mt-1"></i><span><strong>ç„¡è­‰ç”³å ±ï¼š</strong> è‹¥ç„¡ç›¸é—œè­‰ç…§ï¼Œè«‹æ–¼è©²å€å‹¾é¸ã€Œç„¡ç›¸é—œè­‰ç…§ã€ã€‚</span></p>
                </div>
            </div>
        </div>

        <!-- åŸºæœ¬è³‡æ–™ -->
        <section class="glass-card p-6 md:p-10 shadow-xl mb-10 border-t-8 border-slate-800">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-8">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 mb-1 uppercase tracking-widest">èº«åˆ†è­‰å­—è™Ÿ</label>
                    <input type="text" id="idCard" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none transition-all" placeholder="A123456789">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 mb-1 uppercase tracking-widest">å§“å</label>
                    <input type="text" id="name" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none transition-all" placeholder="å…¨å">
                </div>
                <div class="lg:col-span-2">
                    <label class="block text-[10px] font-black text-slate-400 mb-1 uppercase tracking-widest">æ‰€å±¬å¤§éšŠ/æ©Ÿé—œ</label>
                    <select id="bigBrigade" onchange="toggleUnitUI()" class="select-custom w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none font-bold">
                        <option value="">è«‹é¸æ“‡</option>
                        <option value="å±€æœ¬éƒ¨">å±€æœ¬éƒ¨ (ç§‘ã€å®¤ã€ä¸­å¿ƒ)</option>
                        <option value="ç¬¬ä¸€å¤§éšŠ">ç¬¬ä¸€å¤§éšŠ</option>
                        <option value="ç¬¬äºŒå¤§éšŠ">ç¬¬äºŒå¤§éšŠ</option>
                        <option value="ç¬¬ä¸‰å¤§éšŠ">ç¬¬ä¸‰å¤§éšŠ</option>
                        <option value="ç¬¬å››å¤§éšŠ">ç¬¬å››å¤§éšŠ</option>
                    </select>
                </div>
                <div id="hqArea" class="lg:col-span-4 hidden">
                    <label class="block text-[10px] font-black text-blue-600 mb-1 italic">å±€æœ¬éƒ¨ç§‘å®¤/ä¸­å¿ƒåç¨±</label>
                    <input type="text" id="hqDept" class="w-full bg-blue-50 border-2 border-blue-200 rounded-xl p-3 focus:border-blue-500 outline-none" placeholder="ä¾‹å¦‚ï¼šæ•‘è­·ç§‘ã€äººäº‹å®¤...">
                </div>
                <div id="brigadeArea" class="lg:col-span-4 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                    <select id="medBrigade" onchange="updateSmall()" class="select-custom w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none"></select>
                    <select id="smallUnit" class="select-custom w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none"></select>
                </div>
            </div>
        </section>

        <!-- è­‰ç…§å€åŸŸ -->
        <div id="mainForm" class="space-y-8"></div>

        <!-- æäº¤ -->
        <div class="mt-12 mb-24 flex flex-col items-center">
            <button onclick="prepareConfirmation()" class="w-full md:w-auto bg-slate-900 hover:bg-blue-600 text-white px-16 py-5 rounded-[2.5rem] font-black text-xl shadow-2xl transition-all">
                <i class="fa-solid fa-magnifying-glass-chart mr-2"></i> ç”Ÿæˆè©¦ç®—é è¦½
            </button>
        </div>
    </div>

    <!-- æ‡¸æµ®è¨ˆåˆ†æ¿ -->
    <div id="floatingBoard" class="fixed bottom-6 right-6 z-40">
        <div class="bg-white/90 backdrop-blur-md px-6 py-3 rounded-[2rem] shadow-2xl border-2 border-blue-600 flex flex-col items-center">
            <span class="text-[10px] font-black text-blue-600 uppercase tracking-tighter leading-none mb-1 italic">Est. Points</span>
            <span id="floatingScore" class="text-3xl font-black text-slate-800">0.00</span>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden">
            <div class="bg-slate-100 p-8 border-b text-center">
                <h3 class="text-2xl font-black text-slate-800 italic uppercase">ç¢ºèªç”³å ±è³‡æ–™</h3>
            </div>
            <div class="p-8">
                <div id="confirmList" class="space-y-3 mb-8 max-h-[45vh] overflow-y-auto"></div>
                <div class="flex justify-between items-center bg-blue-50 p-6 rounded-[2rem] mb-8 border-2 border-blue-100">
                    <span class="font-bold text-slate-600">é è¨ˆç¸½ç©åˆ†ï¼š</span>
                    <span id="modalTotal" class="text-4xl font-black text-blue-600 tracking-tighter">0.00</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="closeModal()" class="py-4 text-slate-400 font-bold hover:bg-slate-50 rounded-2xl transition">ä¿®æ”¹</button>
                    <button id="finalSubmitBtn" onclick="submitToGas()" class="py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-xl hover:bg-blue-700 transition">ç¢ºå®šé€å‡º</button>
                </div>
            </div>
        </div>
    </div>

    <!-- æˆåŠŸç•«é¢ -->
    <div id="successPage" class="fixed inset-0 bg-slate-100 hidden z-[60] overflow-y-auto p-4 md:p-10">
        <div class="max-w-2xl mx-auto bg-white rounded-[3rem] shadow-2xl overflow-hidden border-t-[12px] border-blue-600">
            <div class="p-10">
                <div class="flex justify-center mb-6">
                    <div class="bg-emerald-100 text-emerald-600 w-20 h-20 rounded-full flex items-center justify-center text-4xl stamp-effect">
                        <i class="fa-solid fa-check-double"></i>
                    </div>
                </div>
                <h2 class="text-3xl font-black text-center text-slate-800 mb-2">ç”³å ±æˆåŠŸ</h2>
                <div class="bg-slate-50 rounded-[2rem] p-8 space-y-4">
                    <div class="flex justify-between border-b pb-2"><span class="text-slate-400">å§“å</span><span id="resName" class="font-bold"></span></div>
                    <div class="flex justify-between border-b pb-2 text-blue-600"><span class="font-bold italic uppercase">Total Points</span><span id="resScore" class="text-2xl font-black"></span></div>
                    <div id="resDetails" class="space-y-2 text-sm text-slate-600"></div>
                </div>
                <button onclick="location.reload()" class="w-full mt-10 py-5 bg-slate-900 text-white rounded-[2rem] font-black hover:bg-slate-800 transition">è¿”å›ç³»çµ±</button>
            </div>
        </div>
    </div>

    <script>
        const AUDIT_UNITS = {
            "ç¬¬ä¸€å¤§éšŠ": { "æœ¬éƒ¨": ["ç¬¬ä¸€æ•‘ç½æ•‘è­·å¤§éšŠ"], "ä¸­æ­£ä¸­éšŠ": ["ä¸­æ­£ä¸­éšŠ", "è¯å±±åˆ†éšŠ", "æ³‰å·åˆ†éšŠ", "å¤äº­åˆ†éšŠ", "åŸä¸­åˆ†éšŠ"], "è¬è¯ä¸­éšŠ": ["è¬è¯ä¸­éšŠ", "é›™åœ’åˆ†éšŠ", "é¾å±±åˆ†éšŠ"], "æ–‡å±±ä¸­éšŠ": ["æ–‡å±±ä¸­éšŠ", "è¬èŠ³åˆ†éšŠ", "æ™¯ç¾åˆ†éšŠ", "æœ¨æŸµåˆ†éšŠ", "å¯¶æ©‹åˆ†éšŠ"] },
            "ç¬¬äºŒå¤§éšŠ": { "æœ¬éƒ¨": ["ç¬¬äºŒæ•‘ç½æ•‘è­·å¤§éšŠ"], "å¤§å®‰ä¸­éšŠ": ["å¤§å®‰ä¸­éšŠ", "é‡‘è¯åˆ†éšŠ", "å¾©èˆˆåˆ†éšŠ", "å®‰å’Œåˆ†éšŠ"], "ä¿¡ç¾©ä¸­éšŠ": ["ä¿¡ç¾©ä¸­éšŠ", "ä¿¡ç¾©åˆ†éšŠ", "èŠæ•¬åˆ†éšŠ"], "å—æ¸¯ä¸­éšŠ": ["å—æ¸¯ä¸­éšŠ", "å—æ¸¯åˆ†éšŠ", "èˆŠèŠåˆ†éšŠ", "æˆå¾·åˆ†éšŠ"] },
            "ç¬¬ä¸‰å¤§éšŠ": { "æœ¬éƒ¨": ["ç¬¬ä¸‰æ•‘ç½æ•‘è­·å¤§éšŠ"], "ä¸­å±±ä¸­éšŠ": ["ä¸­å±±ä¸­éšŠ", "å¤§ç›´åˆ†éšŠ", "åœ“å±±åˆ†éšŠ", "æ¾æ±Ÿåˆ†éšŠ"], "æ¾å±±ä¸­éšŠ": ["æ¾å±±ä¸­éšŠ", "ä¸­å´™åˆ†éšŠ", "å…«å¾·åˆ†éšŠ"], "å…§æ¹–ä¸­éšŠ": ["å…§æ¹–ä¸­éšŠ", "æ°‘æ¬Šåˆ†éšŠ", "å…§æ¹–åˆ†éšŠ", "å¤§æ¹–åˆ†éšŠ", "æ±æ¹–åˆ†éšŠ"] },
            "ç¬¬å››å¤§éšŠ": { "æœ¬éƒ¨": ["ç¬¬å››æ•‘ç½æ•‘è­·å¤§éšŠ"], "å¤§åŒä¸­éšŠ": ["å¤§åŒä¸­éšŠ", "å»ºæˆåˆ†éšŠ", "å»¶å¹³åˆ†éšŠ", "å¤§åŒåˆ†éšŠ"], "å£«æ—ä¸­éšŠ": ["å£«æ—ä¸­éšŠ", "å±±ä»”ååˆ†éšŠ", "å¤©æ¯åˆ†éšŠ", "ç¦å®‰åˆ†éšŠ", "ç¤¾å­åˆ†éšŠ", "åŠæ½­åˆ†éšŠ", "é›™æºªåˆ†éšŠ"], "åŒ—æŠ•ä¸­éšŠ": ["åŒ—æŠ•ä¸­éšŠ", "é™½æ˜å±±åˆ†éšŠ", "å…‰æ˜åˆ†éšŠ", "é—œæ¸¡åˆ†éšŠ", "çŸ³ç‰Œåˆ†éšŠ", "ç§€å±±åˆ†éšŠ"] }
        };

        const CONFIG = [
            { id: "water", title: "æ°´ä¸Šæ•‘ç”Ÿ", items: [{ name: "æ•‘ç”Ÿå“¡", score: 0.35, hasDate: true }, { name: "æ•‘ç”Ÿæ•™ç·´", score: 0.56, hasDate: false }] },
            { id: "swift", title: "æ€¥æµæ•‘æ´", items: [{ name: "æ€¥æµæ•‘æ´è¨“ç·´(40å°æ™‚)", score: 0.56, hasDate: false }, { name: "æ€¥æµæ•‘æ´è¨“ç·´æ•™å®˜ç­(45å°æ™‚)", score: 0.70, hasDate: false }] },
            { id: "dive", title: "æ½›æ°´æ•‘æ´", items: [{ name: "æ•‘æ´æ½›æ°´", score: 0.56, hasDate: false }, { name: "æ½›æ°´æ•™å®˜", score: 0.70, hasDate: false }, { name: "å…¬å…±å®‰å…¨æ½›æ°´(82å°æ™‚)", score: 0.70, hasDate: false }] },
            { id: "rescue", title: "æ¶ˆé˜²æ•‘åŠ©", items: [{ name: "æ•‘åŠ©éšŠè¨“ç·´(320å°æ™‚)", score: 1.05, hasDate: false }] },
            { id: "instr", title: "æ•‘åŠ©å¸«è³‡", items: [{ name: "æ•‘åŠ©éšŠå¸«è³‡ç­(240å°æ™‚)", score: 0.84, hasDate: false }] },
            { id: "fire", title: "ç«ç½æ¶æ•‘", items: [{ name: "ç«ç½æ¶æ•‘æ•™å®˜ç­", score: 0.84, hasDate: false }] },
            { id: "drive", title: "è»Šè¼›é§•é§›", items: [{ name: "å¤§è²¨(å®¢)è»Šé§•ç…§", score: 0.70, hasDate: false }, { name: "è¯çµè»Šé§•ç…§", score: 1.05, hasDate: false }] }
        ];

        function toggleUnitUI() {
            const bigVal = document.getElementById('bigBrigade').value;
            const hqArea = document.getElementById('hqArea'), brArea = document.getElementById('brigadeArea');
            if (bigVal === "å±€æœ¬éƒ¨") { hqArea.classList.remove('hidden'); brArea.classList.add('hidden'); }
            else if (bigVal) { hqArea.classList.add('hidden'); brArea.classList.remove('hidden'); updateMedium(bigVal); }
            else { hqArea.classList.add('hidden'); brArea.classList.add('hidden'); }
        }

        function updateMedium(bigVal) {
            const med = document.getElementById('medBrigade'); med.innerHTML = '<option value="">è«‹é¸æ“‡ä¸­éšŠ</option>';
            document.getElementById('smallUnit').innerHTML = '<option value="">è«‹é¸æ“‡åˆ†éšŠ</option>';
            for (let m in AUDIT_UNITS[bigVal]) med.options.add(new Option(m, m));
        }

        function updateSmall() {
            const bigVal = document.getElementById('bigBrigade').value, medVal = document.getElementById('medBrigade').value;
            const unit = document.getElementById('smallUnit'); unit.innerHTML = '<option value="">è«‹é¸æ“‡åˆ†éšŠ</option>';
            if (AUDIT_UNITS[bigVal][medVal]) AUDIT_UNITS[bigVal][medVal].forEach(u => unit.options.add(new Option(u, u)));
        }

        function initForm() {
            const container = document.getElementById('mainForm');
            CONFIG.forEach(cat => {
                let html = `
                    <div class="glass-card overflow-hidden shadow-lg border-l-[12px] border-slate-200">
                        <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center font-bold">
                            <span class="text-xs uppercase tracking-widest text-slate-400 italic">${cat.title}</span>
                            <div class="flex items-center">
                                <span class="text-[10px] text-blue-500 uppercase font-black tracking-tighter">Picked Highest</span>
                                <span id="tip_${cat.id}" class="text-[10px] text-amber-600 font-bold ml-2"></span>
                            </div>
                        </div>
                        <div class="p-4 md:p-8 space-y-4">
                            <div class="no-cert-card p-5 rounded-2xl flex items-center justify-between cursor-pointer border-2 border-dashed border-slate-200" onclick="toggleNoCert('${cat.id}')" id="noCertBox_${cat.id}">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="noCertCheck_${cat.id}" class="w-7 h-7 rounded-xl text-slate-600 focus:ring-0">
                                    <span class="font-bold text-slate-700 text-sm italic">ç„¡ç›¸é—œè­‰ç…§ / æš«ä¸å¡«å ±</span>
                                </div>
                            </div>
                `;
                cat.items.forEach(item => {
                    html += `
                        <div class="item-row p-5 rounded-[2.5rem] bg-white flex flex-col md:flex-row md:items-center justify-between gap-6 cert-item-${cat.id}" data-cat="${cat.id}" data-score="${item.score}" data-name="${item.name}">
                            <div class="flex items-start gap-3">
                                <input type="radio" name="group_${cat.id}" onchange="handleCertSelect(this, '${cat.id}')" class="w-8 h-8 rounded-full text-blue-600 cert-check mt-1">
                                <div>
                                    <h4 class="font-bold text-slate-800 text-lg">${item.name}</h4>
                                    <p class="text-blue-500 font-black text-xs italic tracking-tighter">+ ${item.score.toFixed(2)} pts</p>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 border-t pt-4 md:border-0 md:pt-0">
                                ${item.hasDate ? `
                                <div class="flex flex-col w-full sm:w-auto">
                                    <span class="text-[10px] font-black text-slate-300 uppercase mb-1 tracking-widest italic">Validity</span>
                                    <div class="flex items-center gap-2">
                                        <input type="date" onchange="updateCalc()" class="cert-date border-2 border-slate-100 rounded-xl p-2 text-xs outline-none focus:border-blue-400 w-full sm:w-32">
                                        <label class="text-[10px] font-bold text-slate-400 flex items-center gap-1 cursor-pointer whitespace-nowrap"><input type="checkbox" onchange="toggleIndefinite(this)"> æ°¸ä¹…</label>
                                    </div>
                                </div>` : `<div class="text-[10px] font-black text-green-600 bg-green-50 px-3 py-1 rounded-full border border-green-200 inline-block uppercase italic">Permanent</div>`}
                                <div class="flex flex-col w-full sm:w-auto">
                                    <span class="text-[10px] font-black text-slate-300 uppercase mb-1 font-bold italic tracking-widest underline decoration-blue-200">Evidence</span>
                                    <input type="file" onchange="updateCalc()" class="cert-file text-[10px] text-slate-400 w-full">
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML += html + `</div></div>`;
            });
            updateCalc();
        }

        function toggleNoCert(id) {
            if (event.target.type !== 'checkbox') {
                document.getElementById(`noCertCheck_${id}`).checked = !document.getElementById(`noCertCheck_${id}`).checked;
            }
            const isChecked = document.getElementById(`noCertCheck_${id}`).checked;
            if (isChecked) {
                document.querySelectorAll(`.cert-item-${id} .cert-check`).forEach(c => c.checked = false);
            }
            updateCalc();
        }

        function handleCertSelect(el, id) { 
            if (el.checked) {
                document.getElementById(`noCertCheck_${id}`).checked = false; 
                const tipEl = document.getElementById(`tip_${id}`);
                if(tipEl) {
                    tipEl.innerText = "ğŸ’¡ å·²è‡ªå‹•åˆ‡æ›è‡³æ­¤é …ç›®";
                    setTimeout(() => { tipEl.innerText = ""; }, 2000);
                }
            }
            updateCalc(); 
        }

        function toggleIndefinite(el) {
            const date = el.closest('.item-row').querySelector('.cert-date');
            date.disabled = el.checked; if (el.checked) date.value = ""; updateCalc();
        }

        function updateCalc() {
            const today = new Date(); today.setHours(0,0,0,0);
            let total = 0;
            CONFIG.forEach(cat => {
                let catMax = 0, winner = null;
                const rows = document.querySelectorAll(`.cert-item-${cat.id}`), isNoCert = document.getElementById(`noCertCheck_${cat.id}`).checked;
                document.getElementById(`noCertBox_${cat.id}`).classList.toggle('no-cert-active', isNoCert);
                
                rows.forEach(row => {
                    const check = row.querySelector('.cert-check').checked;
                    const dateIn = row.querySelector('.cert-date');
                    const isPerm = row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked;
                    row.classList.remove('highest-glow', 'opacity-30');
                    
                    if (isNoCert) {
                        row.classList.add('opacity-30');
                    } else if (check) {
                        let valid = true;
                        if (dateIn && !isPerm) { if (!dateIn.value || new Date(dateIn.value) < today) valid = false; }
                        if (valid) {
                            catMax = parseFloat(row.dataset.score);
                            winner = row;
                        }
                    }
                });
                if (winner) winner.classList.add('highest-glow');
                total += catMax;
            });
            document.getElementById('floatingScore').innerText = total.toFixed(2);
        }

        async function prepareConfirmation() {
            const bigVal = document.getElementById('bigBrigade').value, name = document.getElementById('name').value;
            if (!name || !bigVal) return alert("å€‹äººåŸºæœ¬è³‡æ–™èˆ‡å–®ä½æœªå¡«å¯«å®Œæ•´ï¼");

            const list = document.getElementById('confirmList'); list.innerHTML = "";
            let finalTotal = 0, stop = false;

            CONFIG.forEach(cat => {
                let best = { name: "ç„¡ç›¸é—œè­‰ç…§", score: 0 };
                if (!document.getElementById(`noCertCheck_${cat.id}`).checked) {
                    document.querySelectorAll(`.cert-item-${cat.id}`).forEach(row => {
                        if (row.querySelector('.cert-check').checked) {
                            const dateIn = row.querySelector('.cert-date');
                            const isPerm = row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked;
                            const today = new Date(); today.setHours(0,0,0,0);
                            let isValid = true;
                            if (dateIn && !isPerm) {
                                if (!dateIn.value || new Date(dateIn.value) < today) isValid = false;
                            }
                            if (!isValid) return;

                            if (row.querySelector('.cert-file').files.length === 0) {
                                alert(`ã€${cat.title}ã€‘å‹¾é¸äº†ã€Œ${row.dataset.name}ã€ï¼Œä½†æœªä¸Šå‚³æª”æ¡ˆï¼`);
                                stop = true; return;
                            }
                            best = { name: row.dataset.name, score: parseFloat(row.dataset.score) };
                        }
                    });
                }
                if (stop) return;
                list.innerHTML += `<div class="flex justify-between p-4 bg-slate-50 rounded-2xl mb-2 text-sm border border-slate-100"><span>${cat.title}: <b>${best.name}</b></span><span class="text-blue-600 font-black">+${best.score.toFixed(2)}</span></div>`;
                finalTotal += best.score;
            });
            if (stop) return;
            document.getElementById('modalTotal').innerText = finalTotal.toFixed(2);
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function submitToGas() {
            const btn = document.getElementById('finalSubmitBtn'); btn.disabled = true; btn.innerText = "å‚³é€ä¸­...";
            const payload = {
                idCard: document.getElementById('idCard').value,
                name: document.getElementById('name').value,
                bigBrigade: document.getElementById('bigBrigade').value,
                hqDept: document.getElementById('hqDept').value,
                medBrigade: document.getElementById('medBrigade').value,
                smallUnit: document.getElementById('smallUnit').value,
                certificates: [],
                totalScore: document.getElementById('modalTotal').innerText
            };

            const selected = document.querySelectorAll('.cert-check:checked');
            const detailListHtml = [];
            for (let check of selected) {
                const row = check.closest('.item-row');
                const file = row.querySelector('.cert-file').files[0];
                const dateIn = row.querySelector('.cert-date');
                const isPerm = row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked;
                payload.certificates.push({
                    category: row.dataset.cat, itemName: row.dataset.name, score: row.dataset.score,
                    expiry: isPerm ? "ç„¡æœŸé™" : (dateIn ? dateIn.value : "æ°¸ä¹…"),
                    fileBase64: await toBase64(file), fileName: file.name
                });
                detailListHtml.push(`<p>â€¢ ${row.dataset.name} (+${row.dataset.score})</p>`);
            }

            const GAS_URL = "https://script.google.com/macros/s/AKfycbzFpN4k8k7tQ9o7TpFOewDwSh0wQmtVW9l8BVmFJpj9sIw9Laueq4d4zHLGaz0OIhrv5w/exec"; 
            try {
                await fetch(GAS_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
                document.getElementById('resName').innerText = payload.name;
                document.getElementById('resScore').innerText = payload.totalScore;
                document.getElementById('resDetails').innerHTML = detailListHtml.join('');
                document.getElementById('modal').classList.add('hidden');
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('floatingBoard').classList.add('hidden');
                document.getElementById('successPage').classList.remove('hidden');
                window.scrollTo(0,0);
            } catch(e) {
                alert("å‚³é€å¤±æ•—");
                btn.disabled = false;
            }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
        });

        initForm();
    </script>
</body>
</html>
