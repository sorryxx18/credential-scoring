<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>消防人員陞任積分證照上傳</title>
    <!-- 引入 Bootstrap CSS (可自行替換 CDN 或本地檔案) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { margin-bottom: 20px; }
        .form-check { margin-bottom: 10px; }
        .file-input-group { margin-top: 10px; }
        #loadingIndicator { display: none; }
        #successMessage, #errorMessage { display: none; margin-top: 15px; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">專業或技術能力積分 - 證照上傳</h1>

        <form id="certificateForm">
            <div class="mb-3">
                <label for="idCard" class="form-label">身分證字號 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="idCard" name="idCard" required>
            </div>
            <div class="mb-3">
                <label for="name" class="form-label">姓名 <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="mb-3">
                <label for="unit" class="form-label">服務單位</label>
                <input type="text" class="form-control" id="unit" name="unit">
            </div>

            <!-- 區塊一：水上救生 -->
            <div class="card">
                <div class="card-header">水上救生</div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="water" id="water_lifeguard" value='{"itemName": "救生員", "score": 0.35, "category": "水上救生"}' data-category="water">
                        <label class="form-check-label" for="water_lifeguard">救生員 (0.35分)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="water" id="water_instructor" value='{"itemName": "救生教練", "score": 0.56, "category": "水上救生"}' data-category="water">
                        <label class="form-check-label" for="water_instructor">救生教練 (0.56分)</label>
                    </div>
                    <div class="file-input-group" id="waterFileGroup">
                        <label class="form-label">上傳證照檔案：</label>
                        <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </div>
            </div>

            <!-- 區塊二：急流救援 -->
            <div class="card">
                <div class="card-header">急流救援</div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="swift" id="swift_40h" value='{"itemName": "急流救援訓練(40小時)", "score": 0.56, "category": "急流救援"}' data-category="swift">
                        <label class="form-check-label" for="swift_40h">急流救援訓練(40小時) (0.56分)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="swift" id="swift_instructor" value='{"itemName": "急流救援教官班(45小時)", "score": 0.7, "category": "急流救援"}' data-category="swift">
                        <label class="form-check-label" for="swift_instructor">急流救援教官班(45小時) (0.7分)</label>
                    </div>
                     <div class="file-input-group" id="swiftFileGroup">
                        <label class="form-label">上傳證照檔案：</label>
                        <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </div>
            </div>

            <!-- 區塊三：潛水 -->
            <div class="card">
                <div class="card-header">潛水</div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="dive" id="dive_rescue" value='{"itemName": "救援潛水", "score": 0.56, "category": "潛水"}' data-category="dive">
                        <label class="form-check-label" for="dive_rescue">救援潛水 (0.56分)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="dive" id="dive_instructor" value='{"itemName": "潛水教官", "score": 0.7, "category": "潛水"}' data-category="dive">
                        <label class="form-check-label" for="dive_instructor">潛水教官 (0.7分)</label>
                    </div>
                     <div class="form-check">
                        <input class="form-check-input" type="radio" name="dive" id="dive_public" value='{"itemName": "公共安全潛水(82小時)", "score": 0.7, "category": "潛水"}' data-category="dive">
                        <label class="form-check-label" for="dive_public">公共安全潛水(82小時) (0.7分)</label>
                    </div>
                    <div class="file-input-group" id="diveFileGroup">
                        <label class="form-label">上傳證照檔案：</label>
                        <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </div>
            </div>

            <!-- 區塊四：車輛駕駛 -->
            <div class="card">
                <div class="card-header">車輛駕駛</div>
                <div class="card-body">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="drive" id="drive_truck" value='{"itemName": "大貨(客)車駕照", "score": 0.7, "category": "車輛駕駛"}' data-category="drive">
                        <label class="form-check-label" for="drive_truck">大貨(客)車駕照 (0.7分)</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="drive" id="drive_trailer" value='{"itemName": "聯結車駕照", "score": 1.05, "category": "車輛駕駛"}' data-category="drive">
                        <label class="form-check-label" for="drive_trailer">聯結車駕照 (1.05分)</label>
                    </div>
                     <div class="file-input-group" id="driveFileGroup">
                        <label class="form-label">上傳證照檔案：</label>
                        <input type="file" class="form-control" accept=".pdf,.jpg,.jpeg,.png">
                    </div>
                </div>
            </div>

            <div class="alert alert-info mt-3">
                <strong>提示：</strong><br>
                <ul>
                    <li>請選擇一項證照，並上傳對應的檔案。</li>
                    <li>系統將自動為您計算該項目分數。</li>
                    <li>最終總積分將由後端系統計算，並匯總至您單位的積分表。</li>
                </ul>
            </div>

            <div class="text-center my-4">
                <button type="button" class="btn btn-primary btn-lg" id="submitBtn">送出申請</button>
            </div>
        </form>

        <div id="loadingIndicator" class="text-center my-4">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>正在上傳中，請稍候...</p>
        </div>
        <div id="successMessage" class="alert alert-success" role="alert">
            申請已成功送出！
        </div>
        <div id="errorMessage" class="alert alert-danger" role="alert">
            發生錯誤，請檢查輸入內容或聯繫管理員。
        </div>

    </div>

    <!-- 引入 Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 前端 JavaScript 邏輯 ---

        // 設定為你自己的 Google Apps Script Web App URL
        // 部署 GAS 時，選擇「Anyone」可以存取，並取得 Web URL
        const GAS_WEB_APP_URL = 'YOUR_GAS_WEB_APP_URL'; 

        const scoreRules = {
            "water": { "itemName": "救生員", "score": 0.35, "category": "水上救生" },
            "water_instructor": { "itemName": "救生教練", "score": 0.56, "category": "水上救生" },
            "swift_40h": { "itemName": "急流救援訓練(40小時)", "score": 0.56, "category": "急流救援" },
            "swift_instructor": { "itemName": "急流救援教官班(45小時)", "score": 0.7, "category": "急流救援" },
            "dive_rescue": { "itemName": "救援潛水", "score": 0.56, "category": "潛水" },
            "dive_instructor": { "itemName": "潛水教官", "score": 0.7, "category": "潛水" },
            "dive_public": { "itemName": "公共安全潛水(82小時)", "score": 0.7, "category": "潛水" },
            "drive_truck": { "itemName": "大貨(客)車駕照", "score": 0.7, "category": "車輛駕駛" },
            "drive_trailer": { "itemName": "聯結車駕照", "score": 1.05, "category": "車輛駕駛" }
        };

        // 獲取所有 Radio 按鈕元素
        const radioButtons = document.querySelectorAll('input[type="radio"]');
        const fileInputs = document.querySelectorAll('.file-input-group input[type="file"]');
        const submitBtn = document.getElementById('submitBtn');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');
        const form = document.getElementById('certificateForm');

        // --- 事件監聽 ---
        radioButtons.forEach(radio => {
            radio.addEventListener('change', handleRadioChange);
        });
        fileInputs.forEach(fileInput => {
            fileInput.addEventListener('change', handleFileChange);
        });
        submitBtn.addEventListener('click', handleSubmit);

        // --- 處理 Radio 按鈕變動 ---
        function handleRadioChange(event) {
            const selectedCategory = event.target.getAttribute('data-category');
            const selectedFileGroup = document.querySelector(`div[id="${selectedCategory}FileGroup"] input[type="file"]`);
            
            // 啟用對應的 file input
            if (selectedFileGroup) {
                selectedFileGroup.disabled = false;
                // 清空之前上傳的檔案（如果換選的話）
                selectedFileGroup.value = ''; 
            }
            
            // 禁用其他未選擇的 file input
            fileInputs.forEach(input => {
                if (input !== selectedFileGroup && input.closest('.file-input-group').id !== `${selectedCategory}FileGroup`) {
                    input.disabled = true;
                    input.value = ''; // 清空檔案
                }
            });
             // 重新計算預計得分
            calculateAndDisplayScore();
        }

        // --- 處理 File Input 變動 ---
        function handleFileChange(event) {
            const selectedRadio = event.target.closest('.file-input-group').previousElementSibling.querySelector('input[type="radio"]:checked');
            if (!selectedRadio) {
                alert("請先選擇您要申請的證照項目！");
                event.target.value = ''; // 清空選擇的檔案
            }
            // 檢查檔案大小 (這裡可以自行設定限制，例如 5MB)
            if (event.target.files.length > 0 && event.target.files[0].size > 5 * 1024 * 1024) {
                alert("檔案過大，請上傳小於 5MB 的檔案。");
                event.target.value = '';
            }
        }

        // --- 轉換檔案為 Base64 ---
        async function getBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result.split(',')[1]); // 提取 Base64 部分
                reader.onerror = error => reject(error);
            });
        }

        // --- 遞送資料到 GAS ---
        async function handleSubmit() {
            const idCard = document.getElementById('idCard').value.trim();
            const name = document.getElementById('name').value.trim();
            const unit = document.getElementById('unit').value.trim();

            if (!idCard || !name) {
                alert("身分證字號與姓名為必填欄位。");
                return;
            }

            let selectedCertificate = null;
            let attachedFile = null;
            let fileInputGroup = null;

            // 找出被選中的證照項目與對應的檔案
            for (const key in scoreRules) {
                const radio = document.querySelector(`input[name="${key.split('_')[0]}"]:checked`); // 根據 name 屬性查找
                if (radio && radio.value.includes(scoreRules[key].itemName)) {
                    selectedCertificate = { ...scoreRules[key] }; // 複製規則
                    
                    // 找到對應的 file input
                    fileInputGroup = document.querySelector(`div[id="${key}FileGroup"]`);
                    if (fileInputGroup && fileInputGroup.querySelector('input[type="file"]').files.length > 0) {
                        attachedFile = fileInputGroup.querySelector('input[type="file"]').files[0];
                        break; // 找到一筆就跳出
                    } else {
                        // 如果有勾選但沒有檔案
                        alert(`請上傳 ${selectedCertificate.itemName} 的檔案。`);
                        return; 
                    }
                }
            }

            if (!selectedCertificate) {
                alert("請至少選擇一項證照。");
                return;
            }

            loadingIndicator.style.display = 'block';
            submitBtn.disabled = true;
            successMessage.style.display = 'none';
            errorMessage.style.display = 'none';

            let fileBase64 = null;
            let fileName = null;
            let fileType = null;

            if (attachedFile) {
                try {
                    fileBase64 = await getBase64(attachedFile);
                    fileName = attachedFile.name;
                    fileType = attachedFile.type;
                } catch (error) {
                    console.error("Error reading file:", error);
                    errorMessage.innerText = "讀取檔案時發生錯誤：" + error.message;
                    errorMessage.style.display = 'block';
                    loadingIndicator.style.display = 'none';
                    submitBtn.disabled = false;
                    return;
                }
            }
            
            const payload = {
                idCard: idCard,
                name: name,
                unit: unit,
                certificates: [
                    {
                        ...selectedCertificate, // 包含 itemName, score, category
                        fileName: fileName,
                        fileType: fileType,
                        fileBase64: fileBase64
                    }
                ]
            };

            fetch(GAS_WEB_APP_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            })
            .then(response => response.json())
            .then(data => {
                if (data.result === 'success') {
                    successMessage.innerText = `申請已成功送出！(${selectedCertificate.itemName})`;
                    successMessage.style.display = 'block';
                    form.reset(); // 清空表單
                    // 重新啟用所有 file input，因為 reset 後會被 disabled
                    fileInputs.forEach(input => input.disabled = false);
                } else {
                    errorMessage.innerText = "伺服器回傳錯誤：" + (data.message || '未知錯誤');
                    errorMessage.style.display = 'block';
                    console.error("Server Error:", data.message);
                }
            })
            .catch(error => {
                errorMessage.innerText = "網路請求發生錯誤：" + error.message;
                errorMessage.style.display = 'block';
                console.error("Network Error:", error);
            })
            .finally(() => {
                loadingIndicator.style.display = 'none';
                submitBtn.disabled = false;
            });
        }
        
        // --- 初始化：先禁用所有 File Input，除了第一個被勾選的 ---
        function initializeForm() {
            fileInputs.forEach(input => input.disabled = true);
        }
        
        // --- 初始載入時執行 ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeForm();
            calculateAndDisplayScore(); // 顯示初始的 0.00 分
        });
        
        // --- 計算並顯示預計總分 (目前前端只計算單項，總分由後端GAS計算) ---
        // !!! 注意：前端在這裡不計算總分，只確認使用者有選擇證照 !!!
        // !!! 最終的「擇優取最大值」和「總分加總」應該由 GAS 或 Sheet 公式執行 !!!
        function calculateAndDisplayScore() {
            // 此處可以加入「前端預覽」功能，但為了準確性，最終分數計算放在 Sheet
            // 這裡僅做基本的勾選驗證
             let anySelected = false;
             radioButtons.forEach(radio => {
                 if(radio.checked) anySelected = true;
             });
             if(anySelected) {
                 // 可以在這裡顯示一個「您選擇了XXX，預計得分XXX」的提示
             }
        }

    </script>
</body>
</html>
