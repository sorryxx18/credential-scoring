<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業技術能力積分申報系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #d1d5db 100%); min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 2rem; border: 1px solid rgba(255, 255, 255, 0.5); }
        .item-row { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid transparent; }
        .highest-glow { border-color: #2563eb; background: #eff6ff; box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.2); }
        .badge-status { font-weight: bold; font-size: 0.7rem; padding: 2px 12px; border-radius: 999px; }
        .select-custom { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; }
    </style>
</head>
<body class="p-4 md:p-10 text-slate-800">

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-12 gap-6">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-3 rounded-2xl shadow-lg text-white">
                    <i class="fa-solid fa-fire-extinguisher text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-black text-slate-800 tracking-tight">專業技術能力積分申報</h1>
                    <p class="text-slate-500 font-medium">Professional Skill Credits Reporting System</p>
                </div>
            </div>
            <div class="bg-white/50 backdrop-blur px-6 py-2 rounded-2xl border border-white/50 shadow-sm text-center">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">Authorized by</p>
                <p class="text-blue-700 font-bold">臺北市政府消防局</p>
            </div>
        </header>

        <!-- 說明卡 -->
        <div class="glass-card p-8 mb-10 shadow-2xl relative overflow-hidden">
            <div class="grid md:grid-cols-3 gap-8 items-center">
                <div class="md:col-span-2">
                    <h2 class="text-xl font-bold text-slate-800 mb-4 flex items-center">
                        <i class="fa-solid fa-circle-check text-blue-600 mr-2"></i> 申報邏輯與規則
                    </h2>
                    <div class="space-y-3 text-sm text-slate-600 leading-relaxed">
                        <p><i class="fa-solid fa-star text-amber-400 mr-2"></i><strong>擇優採計：</strong> 同一類別（如水上救生）系統自動取分數最高之一項。</p>
                        <p><i class="fa-solid fa-calendar-day text-blue-500 mr-2"></i><strong>效期注意：</strong> 僅「救生員」需填寫期限，其餘證照預設為永久有效。</p>
                        <p><i class="fa-solid fa-file-pdf text-red-500 mr-2"></i><strong>附件必要：</strong> 每一項申報必須上傳證照影本，否則視為無效。</p>
                    </div>
                </div>
                <div class="bg-gradient-to-br from-blue-600 to-blue-800 rounded-3xl p-6 text-white text-center shadow-lg">
                    <p class="text-xs font-bold opacity-80 mb-1">CURRENT ESTIMATED SCORE</p>
                    <span id="floatingScore" class="text-5xl font-black">0.00</span>
                    <p class="text-[10px] mt-2 opacity-60 italic">系統將自動判定擇優項目</p>
                </div>
            </div>
        </div>

        <!-- 基本資料與單位選擇 -->
        <section class="glass-card p-8 shadow-xl mb-10 border-t-8 border-blue-600">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                <div class="lg:col-span-1">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">身分證字號</label>
                    <input type="text" id="idCard" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none" placeholder="A123456789">
                </div>
                <div class="lg:col-span-1">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">姓名</label>
                    <input type="text" id="name" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none" placeholder="輸入全名">
                </div>
                <!-- 單位選單 -->
                <div class="lg:col-span-1">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">所屬大隊</label>
                    <select id="bigBrigade" onchange="updateMedium()" class="select-custom w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none cursor-pointer">
                        <option value="">請選擇</option>
                    </select>
                </div>
                <div class="lg:col-span-1">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">所屬中隊</label>
                    <select id="medBrigade" onchange="updateSmall()" class="select-custom w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none cursor-pointer">
                        <option value="">請選擇</option>
                    </select>
                </div>
                <div class="lg:col-span-1">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">所屬分隊</label>
                    <select id="unit" class="select-custom w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none cursor-pointer">
                        <option value="">請選擇</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- 證照區域 -->
        <div id="mainForm" class="space-y-10">
            <!-- JS 生成 -->
        </div>

        <!-- 按鈕 -->
        <div class="mt-16 mb-32 flex flex-col items-center">
            <button onclick="prepareConfirmation()" class="group bg-slate-900 hover:bg-blue-700 text-white px-16 py-5 rounded-[2rem] font-black text-xl shadow-2xl transition-all hover:-translate-y-1 active:scale-95">
                <i class="fa-solid fa-file-invoice mr-2"></i> 生成積分預覽
            </button>
            <p class="mt-4 text-slate-400 text-xs font-bold">送出前系統會進行最後一次自動擇優計算</p>
        </div>
    </div>

    <!-- 彈窗 -->
    <div id="modal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xl rounded-[3.5rem] shadow-2xl overflow-hidden">
            <div class="bg-slate-100 p-10 flex justify-between items-center">
                <div>
                    <h3 class="text-3xl font-black text-slate-800 italic tracking-tighter">SUMMARY</h3>
                    <p class="text-slate-500 font-bold">積分試算對帳單</p>
                </div>
                <div class="text-6xl text-slate-200"><i class="fa-solid fa-list-check"></i></div>
            </div>
            <div class="p-10">
                <div id="confirmList" class="space-y-3 mb-8"></div>
                <div class="flex justify-between items-center bg-blue-600 p-8 rounded-[2.5rem] mb-8 text-white">
                    <span class="font-bold opacity-80">總申報積分預估：</span>
                    <span id="modalTotal" class="text-5xl font-black">0.00</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="closeModal()" class="py-5 text-slate-400 font-bold hover:bg-slate-50 rounded-2xl transition">返回修改</button>
                    <button id="finalSubmitBtn" onclick="submitToGas()" class="py-5 bg-blue-600 text-white font-bold rounded-2xl shadow-xl hover:bg-blue-700 transition">確認送出</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 單位資料
        const AUDIT_UNITS = {
            "第一大隊": {
                "本部": ["第一救災救護大隊"],
                "中正中隊": ["中正中隊", "華山分隊", "泉州分隊", "古亭分隊", "城中分隊"], 
                "萬華中隊": ["萬華中隊", "雙園分隊", "龍山分隊"],
                "文山中隊": ["文山中隊", "萬芳分隊", "景美分隊", "木柵分隊", "寶橋分隊"]
            },
            "第二大隊": {
                "本部": ["第二救災救護大隊"],
                "大安中隊": ["大安中隊", "金華分隊", "復興分隊", "安和分隊"],
                "信義中隊": ["信義中隊", "信義分隊", "莊敬分隊"], 
                "南港中隊": ["南港中隊", "南港分隊", "舊莊分隊", "成德分隊"]
            },
            "第三大隊": {
                "本部": ["第三救災救護大隊"],
                "中山中隊": ["中山中隊", "大直分隊", "圓山分隊", "松江分隊"], 
                "松山中隊": ["松山中隊", "中崙分隊", "八德分隊"],
                "內湖中隊": ["內湖中隊", "民權分隊", "內湖分隊", "大湖分隊", "東湖分隊"]
            },
            "第四大隊": {
                "本部": ["第四救災救護大隊"],
                "大同中隊": ["大同中隊", "建成分隊", "延平分隊", "大同分隊"],
                "士林中隊": ["士林中隊", "山仔后分隊", "天母分隊", "福安分隊", "社子分隊", "劍潭分隊", "雙溪分隊"], 
                "北投中隊": ["北投中隊", "陽明山分隊", "光明分隊", "關渡分隊", "石牌分隊", "秀山分隊"]
            }
        };

        const CONFIG = [
            { id: "water", title: "水上救生", items: [{ name: "救生員", score: 0.35, hasExpiry: true }, { name: "救生教練", score: 0.56, hasExpiry: false }] },
            { id: "swift", title: "急流救援", items: [{ name: "急流救援訓練(40小時)", score: 0.56, hasExpiry: false }, { name: "急流救援訓練教官班(45小時)", score: 0.70, hasExpiry: false }] },
            { id: "dive", title: "潛水救援", items: [{ name: "救援潛水", score: 0.56, hasExpiry: false }, { name: "潛水教官", score: 0.70, hasExpiry: false }, { name: "公共安全潛水(82小時)", score: 0.70, hasExpiry: false }] },
            { id: "drive", title: "車輛駕駛", items: [{ name: "大貨(客)車駕照", score: 0.70, hasExpiry: false }, { name: "聯結車駕照", score: 1.05, hasExpiry: false }] }
        ];

        // 單位連動邏輯
        function initUnits() {
            const big = document.getElementById('bigBrigade');
            for (let b in AUDIT_UNITS) {
                big.options.add(new Option(b, b));
            }
        }

        function updateMedium() {
            const bigVal = document.getElementById('bigBrigade').value;
            const med = document.getElementById('medBrigade');
            const unit = document.getElementById('unit');
            med.innerHTML = '<option value="">請選擇</option>';
            unit.innerHTML = '<option value="">請選擇</option>';
            if (bigVal) {
                for (let m in AUDIT_UNITS[bigVal]) {
                    med.options.add(new Option(m, m));
                }
            }
        }

        function updateSmall() {
            const bigVal = document.getElementById('bigBrigade').value;
            const medVal = document.getElementById('medBrigade').value;
            const unit = document.getElementById('unit');
            unit.innerHTML = '<option value="">請選擇</option>';
            if (bigVal && medVal) {
                AUDIT_UNITS[bigVal][medVal].forEach(u => {
                    unit.options.add(new Option(u, u));
                });
            }
        }

        // 渲染證照
        function initForm() {
            const container = document.getElementById('mainForm');
            CONFIG.forEach(cat => {
                let html = `<div class="glass-card overflow-hidden shadow-lg border-l-8 border-slate-200 hover:border-blue-500 transition-all"><div class="bg-slate-50/80 px-8 py-4 border-b flex justify-between items-center"><span class="font-black text-slate-400 text-[10px] tracking-widest uppercase">${cat.title}</span><span class="text-[10px] font-bold text-blue-500 uppercase">擇優取最高分</span></div><div class="p-4 md:p-8 space-y-6">`;
                cat.items.forEach(item => {
                    html += `<div class="item-row p-6 rounded-[2rem] bg-white border-2 border-slate-50 flex flex-col md:flex-row md:items-center justify-between gap-6" data-cat="${cat.id}" data-score="${item.score}" data-name="${item.name}">
                        <div class="flex items-center gap-5">
                            <input type="checkbox" onchange="updateCalc()" class="w-8 h-8 rounded-xl text-blue-600 focus:ring-0 cert-check cursor-pointer">
                            <div><h4 class="font-bold text-slate-800 text-lg">${item.name}</h4><p class="text-blue-600 font-black text-xs tracking-widest">+ ${item.score.toFixed(2)} pts</p></div>
                        </div>
                        <div class="flex flex-wrap items-center gap-6">
                            <div class="flex flex-col min-w-[150px]">
                                <span class="text-[10px] font-black text-slate-300 uppercase mb-1">有效期限</span>
                                ${item.hasExpiry ? `<div class="flex items-center gap-2"><input type="date" onchange="updateCalc()" class="cert-date border-2 border-slate-100 rounded-xl p-2 text-xs focus:border-blue-400 outline-none"><label class="text-[10px] flex items-center gap-1 cursor-pointer"><input type="checkbox" onchange="toggleDate(this)"> 無期限</label></div>` : `<span class="badge-status bg-green-50 text-green-600 border border-green-200">永久有效</span>`}
                            </div>
                            <div class="flex flex-col">
                                <span class="text-[10px] font-black text-slate-300 uppercase mb-1">檔案上傳</span>
                                <input type="file" onchange="updateCalc()" class="cert-file text-[10px] w-40 text-slate-400 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-slate-100 file:text-slate-600 hover:file:bg-blue-50">
                            </div>
                        </div>
                    </div>`;
                });
                container.innerHTML += html + `</div></div>`;
            });
            initUnits();
            updateCalc();
        }

        function toggleDate(el) {
            const dateInput = el.closest('.item-row').querySelector('.cert-date');
            dateInput.disabled = el.checked;
            if (el.checked) dateInput.value = "";
            updateCalc();
        }

        function updateCalc() {
            const today = new Date(); today.setHours(0,0,0,0);
            let total = 0;
            CONFIG.forEach(cat => {
                let catMax = 0; let winner = null;
                const rows = document.querySelectorAll(`.item-row[data-cat="${cat.id}"]`);
                rows.forEach(row => {
                    const isChecked = row.querySelector('.cert-check').checked;
                    const dateInput = row.querySelector('.cert-date');
                    const noExpiry = row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked;
                    row.classList.remove('highest-glow', 'opacity-30');
                    if (isChecked) {
                        let valid = true;
                        if (dateInput && !noExpiry) {
                            if (!dateInput.value || new Date(dateInput.value) < today) valid = false;
                        }
                        if (valid && parseFloat(row.dataset.score) > catMax) {
                            catMax = parseFloat(row.dataset.score); winner = row;
                        }
                    }
                });
                if (winner) {
                    rows.forEach(r => { if(r === winner) r.classList.add('highest-glow'); else if(r.querySelector('.cert-check').checked) r.classList.add('opacity-30'); });
                }
                total += catMax;
            });
            document.getElementById('floatingScore').innerText = total.toFixed(2);
        }

        function prepareConfirmation() {
            if (!document.getElementById('name').value || !document.getElementById('unit').value) return alert("請完整填寫個人基本資料及所屬單位！");
            const list = document.getElementById('confirmList'); list.innerHTML = "";
            let finalTotal = 0; const today = new Date(); today.setHours(0,0,0,0);

            CONFIG.forEach(cat => {
                let best = { name: "無", score: 0 };
                document.querySelectorAll(`.item-row[data-cat="${cat.id}"]`).forEach(row => {
                    const isChecked = row.querySelector('.cert-check').checked;
                    const dateInput = row.querySelector('.cert-date');
                    const noExpiry = row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked;
                    if (isChecked) {
                        let valid = true;
                        if (dateInput && !noExpiry) if (!dateInput.value || new Date(dateInput.value) < today) valid = false;
                        if (valid && parseFloat(row.dataset.score) > best.score) best = { name: row.dataset.name, score: parseFloat(row.dataset.score) };
                    }
                });
                list.innerHTML += `<div class="flex justify-between items-center p-5 bg-slate-50 rounded-3xl border border-slate-100"><div><p class="text-[10px] font-black text-slate-300 uppercase">${cat.title}</p><p class="font-bold text-slate-700">${best.name}</p></div><p class="text-xl font-black text-blue-600">+${best.score.toFixed(2)}</p></div>`;
                finalTotal += best.score;
            });
            document.getElementById('modalTotal').innerText = finalTotal.toFixed(2);
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function submitToGas() {
            const btn = document.getElementById('finalSubmitBtn'); btn.disabled = true; btn.innerText = "傳送中...";
            const payload = {
                idCard: document.getElementById('idCard').value,
                name: document.getElementById('name').value,
                bigBrigade: document.getElementById('bigBrigade').value,
                medBrigade: document.getElementById('medBrigade').value,
                unit: document.getElementById('unit').value,
                certificates: []
            };
            const rows = document.querySelectorAll('.cert-check:checked');
            for (let check of rows) {
                const row = check.closest('.item-row');
                const file = row.querySelector('.cert-file').files[0];
                payload.certificates.push({
                    category: row.dataset.cat, itemName: row.dataset.name, score: row.dataset.score,
                    expiryDate: row.querySelector('.cert-date')?.value || (row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked ? "無期限" : "永久有效"),
                    fileBase64: file ? await toBase64(file) : null, fileName: file ? file.name : ""
                });
            }
            const GAS_URL = "你的GAS佈署網址"; 
            try {
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.result === "success") { alert("申報成功！"); location.reload(); } else alert("發生錯誤：" + json.message);
            } catch(e) { alert("連線失敗"); }
            btn.disabled = false; btn.innerText = "確認送出";
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
        });

        initForm();
    </script>
</body>
</html>
