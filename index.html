<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>專業技術能力積分申報系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f1f5f9; -webkit-tap-highlight-color: transparent; }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.4); }
        .item-row { transition: all 0.2s ease; border: 2px solid #f1f5f9; }
        .highest-glow { border-color: #2563eb !important; background: #eff6ff; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1); }
        .no-cert-card { background: #f8fafc; border: 2px dashed #cbd5e1; transition: all 0.2s; }
        .no-cert-active { background: #f1f5f9; border-color: #94a3b8; opacity: 0.7; }
        .select-custom { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; }
        
        /* 手機版樣式補強 */
        @media (max-width: 640px) {
            .p-10 { padding: 1.25rem !important; }
            .p-8 { padding: 1rem !important; }
            .cert-file { width: 100% !important; margin-top: 0.5rem; }
            .modal-content { border-radius: 1.5rem !important; }
        }
    </style>
</head>
<body class="p-2 md:p-10 text-slate-800">

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-4 rounded-3xl shadow-xl text-white">
                    <i class="fa-solid fa-fire-extinguisher text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl md:text-3xl font-black tracking-tight">專業技術積分申報</h1>
                    <p class="text-slate-500 font-bold italic underline decoration-blue-500 underline-offset-4 uppercase text-[10px]">TPE Fire Department</p>
                </div>
            </div>
            <div class="bg-white px-6 py-2 rounded-2xl shadow-sm border border-slate-200 text-center hidden md:block">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1">Status</p>
                <p class="text-blue-700 font-black">台北市消防局</p>
            </div>
        </header>

        <!-- 個人基本資料 -->
        <section class="glass-card p-6 md:p-10 shadow-xl mb-10 border-t-8 border-slate-800">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-8">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 mb-1 uppercase tracking-widest">身分證字號</label>
                    <input type="text" id="idCard" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none" placeholder="A123456789">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 mb-1 uppercase tracking-widest">姓名</label>
                    <input type="text" id="name" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none" placeholder="全名">
                </div>
                <div class="lg:col-span-2">
                    <label class="block text-[10px] font-black text-slate-400 mb-1 uppercase tracking-widest">所屬大隊/機關</label>
                    <select id="bigBrigade" onchange="toggleUnitUI()" class="select-custom w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none font-bold">
                        <option value="">請選擇</option>
                        <option value="局本部">局本部 (科、室、中心)</option>
                        <option value="第一大隊">第一大隊</option>
                        <option value="第二大隊">第二大隊</option>
                        <option value="第三大隊">第三大隊</option>
                        <option value="第四大隊">第四大隊</option>
                    </select>
                </div>

                <div id="hqArea" class="lg:col-span-4 hidden">
                    <label class="block text-[10px] font-black text-blue-600 mb-1 uppercase tracking-widest italic font-bold">局本部科室/中心名稱</label>
                    <input type="text" id="hqDept" class="w-full bg-blue-50 border-2 border-blue-200 rounded-xl p-3 focus:border-blue-500 outline-none" placeholder="例如：人事室、救護科、大安分隊...">
                </div>

                <div id="brigadeArea" class="lg:col-span-4 grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 mb-1 uppercase tracking-widest font-bold">中隊</label>
                        <select id="medBrigade" onchange="updateSmall()" class="select-custom w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none"></select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 mb-1 uppercase tracking-widest font-bold">分隊 / 本部</label>
                        <select id="smallUnit" class="select-custom w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none"></select>
                    </div>
                </div>
            </div>
        </section>

        <!-- 證照區域 -->
        <div id="mainForm" class="space-y-8"></div>

        <!-- 按鈕 -->
        <div class="mt-12 mb-24 flex flex-col items-center">
            <button onclick="prepareConfirmation()" class="w-full md:w-auto bg-slate-900 hover:bg-blue-600 text-white px-20 py-5 rounded-[2.5rem] font-black text-xl shadow-2xl transition-all active:scale-95">
                <i class="fa-solid fa-calculator mr-2"></i> 預覽試算積分
            </button>
        </div>
    </div>

    <!-- 懸浮計分板 -->
    <div class="fixed bottom-6 right-6 z-40">
        <div class="bg-white/90 backdrop-blur-md px-6 py-3 rounded-[2rem] shadow-2xl border-2 border-blue-600 flex flex-col items-center">
            <span class="text-[10px] font-black text-blue-600 uppercase tracking-tighter leading-none mb-1">Est. Points</span>
            <span id="floatingScore" class="text-3xl font-black text-slate-800">0.00</span>
        </div>
    </div>

    <!-- 預覽彈窗 -->
    <div id="modal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden modal-content">
            <div class="bg-slate-100 p-8 border-b">
                <h3 class="text-2xl font-black text-slate-800 italic tracking-tighter uppercase">Preview Report</h3>
                <p class="text-slate-500 text-sm font-bold mt-1">系統將依最高分項目填入報表並產生連結：</p>
            </div>
            <div class="p-8">
                <div id="confirmList" class="space-y-3 mb-8 max-h-[45vh] overflow-y-auto"></div>
                <div class="flex justify-between items-center bg-blue-50 p-6 rounded-[2rem] mb-8 border-2 border-blue-100">
                    <span class="font-bold text-slate-600">總申報積分：</span>
                    <span id="modalTotal" class="text-4xl font-black text-blue-600 tracking-tighter">0.00</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="closeModal()" class="py-4 text-slate-400 font-bold hover:bg-slate-50 rounded-2xl transition">修改</button>
                    <button id="finalSubmitBtn" onclick="submitToGas()" class="py-4 bg-blue-600 text-white font-bold rounded-2xl shadow-xl hover:bg-blue-700 transition">確認送出</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const AUDIT_UNITS = {
            "第一大隊": { "本部": ["第一救災救護大隊"], "中正中隊": ["中正中隊", "華山分隊", "泉州分隊", "古亭分隊", "城中分隊"], "萬華中隊": ["萬華中隊", "雙園分隊", "龍山分隊"], "文山中隊": ["文山中隊", "萬芳分隊", "景美分隊", "木柵分隊", "寶橋分隊"] },
            "第二大隊": { "本部": ["第二救災救護大隊"], "大安中隊": ["大安中隊", "金華分隊", "復興分隊", "安和分隊"], "信義中隊": ["信義中隊", "信義分隊", "莊敬分隊"], "南港中隊": ["南港中隊", "南港分隊", "舊莊分隊", "成德分隊"] },
            "第三大隊": { "本部": ["第三救災救護大隊"], "中山中隊": ["中山中隊", "大直分隊", "圓山分隊", "松江分隊"], "松山中隊": ["松山中隊", "中崙分隊", "八德分隊"], "內湖中隊": ["內湖中隊", "民權分隊", "內湖分隊", "大湖分隊", "東湖分隊"] },
            "第四大隊": { "本部": ["第四救災救護大隊"], "大同中隊": ["大同中隊", "建成分隊", "延平分隊", "大同分隊"], "士林中隊": ["士林中隊", "山仔后分隊", "天母分隊", "福安分隊", "社子分隊", "劍潭分隊", "雙溪分隊"], "北投中隊": ["北投中隊", "陽明山分隊", "光明分隊", "關渡分隊", "石牌分隊", "秀山分隊"] }
        };

        const CONFIG = [
            { id: "water", title: "水上救生", items: [{ name: "救生員", score: 0.35, hasDate: true }, { name: "救生教練", score: 0.56, hasDate: false }] },
            { id: "swift", title: "急流救援", items: [{ name: "急流救援訓練(40小時)", score: 0.56, hasDate: false }, { name: "急流救援教官班(45小時)", score: 0.70, hasDate: false }] },
            { id: "dive", title: "潛水救援", items: [{ name: "救援潛水", score: 0.56, hasDate: false }, { name: "潛水教官", score: 0.70, hasDate: false }, { name: "公共安全潛水(82小時)", score: 0.70, hasDate: false }] },
            { id: "drive", title: "車輛駕駛", items: [{ name: "大貨(客)車駕照", score: 0.70, hasDate: false }, { name: "聯結車駕照", score: 1.05, hasDate: false }] }
        ];

        function toggleUnitUI() {
            const bigVal = document.getElementById('bigBrigade').value;
            const hqArea = document.getElementById('hqArea'), brArea = document.getElementById('brigadeArea');
            if (bigVal === "局本部") { hqArea.classList.remove('hidden'); brArea.classList.add('hidden'); }
            else if (bigVal) { hqArea.classList.add('hidden'); brArea.classList.remove('hidden'); updateMedium(bigVal); }
            else { hqArea.classList.add('hidden'); brArea.classList.add('hidden'); }
        }

        function updateMedium(bigVal) {
            const med = document.getElementById('medBrigade'); med.innerHTML = '<option value="">請選擇中隊</option>';
            document.getElementById('smallUnit').innerHTML = '<option value="">請選擇分隊</option>';
            for (let m in AUDIT_UNITS[bigVal]) med.options.add(new Option(m, m));
        }

        function updateSmall() {
            const bigVal = document.getElementById('bigBrigade').value, medVal = document.getElementById('medBrigade').value;
            const unit = document.getElementById('smallUnit'); unit.innerHTML = '<option value="">請選擇分隊</option>';
            if (AUDIT_UNITS[bigVal][medVal]) AUDIT_UNITS[bigVal][medVal].forEach(u => unit.options.add(new Option(u, u)));
        }

        function initForm() {
            const container = document.getElementById('mainForm');
            CONFIG.forEach(cat => {
                let html = `
                    <div class="glass-card overflow-hidden shadow-lg border-l-[12px] border-slate-200">
                        <div class="bg-slate-50 px-6 py-4 border-b flex justify-between items-center font-bold">
                            <span class="text-xs uppercase tracking-widest text-slate-400 italic">${cat.title}</span>
                            <span class="text-[10px] text-blue-500 uppercase">Picked Highest</span>
                        </div>
                        <div class="p-4 md:p-8 space-y-4">
                            <div class="no-cert-card p-5 rounded-2xl flex items-center justify-between cursor-pointer" onclick="toggleNoCert('${cat.id}')" id="noCertBox_${cat.id}">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" id="noCertCheck_${cat.id}" class="w-7 h-7 rounded-xl text-slate-600 focus:ring-0">
                                    <span class="font-bold text-slate-700 text-sm">無相關證照 / 暫不申報</span>
                                </div>
                            </div>
                `;
                cat.items.forEach(item => {
                    html += `
                        <div class="item-row p-5 rounded-[2.5rem] bg-white flex flex-col md:flex-row md:items-center justify-between gap-6 cert-item-${cat.id}" data-cat="${cat.id}" data-score="${item.score}" data-name="${item.name}">
                            <div class="flex items-start gap-3">
                                <input type="checkbox" onchange="handleCertSelect(this, '${cat.id}')" class="w-8 h-8 rounded-xl text-blue-600 cert-check mt-1">
                                <div>
                                    <h4 class="font-bold text-slate-800 text-lg">${item.name}</h4>
                                    <p class="text-blue-500 font-black text-xs italic">+ ${item.score.toFixed(2)} pts</p>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 border-t pt-4 md:border-0 md:pt-0">
                                ${item.hasDate ? `
                                <div class="flex flex-col w-full sm:w-auto">
                                    <span class="text-[10px] font-black text-slate-300 uppercase mb-1">Validity</span>
                                    <div class="flex items-center gap-2">
                                        <input type="date" onchange="updateCalc()" class="cert-date border-2 border-slate-100 rounded-xl p-2 text-xs outline-none focus:border-blue-400 w-full sm:w-32">
                                        <label class="text-[10px] font-bold text-slate-400 flex items-center gap-1 cursor-pointer"><input type="checkbox" onchange="toggleIndefinite(this)"> 永久</label>
                                    </div>
                                </div>` : ''}
                                <div class="flex flex-col w-full sm:w-auto">
                                    <span class="text-[10px] font-black text-slate-300 uppercase mb-1 font-bold">Evidence</span>
                                    <input type="file" onchange="updateCalc()" class="cert-file text-[10px] text-slate-400 w-full">
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML += html + `</div></div>`;
            });
        }

        function toggleNoCert(id) {
            if (event.target.type !== 'checkbox') document.getElementById(`noCertCheck_${id}`).checked = !document.getElementById(`noCertCheck_${id}`).checked;
            const isChecked = document.getElementById(`noCertCheck_${id}`).checked;
            if (isChecked) document.querySelectorAll(`.cert-item-${id} .cert-check`).forEach(c => c.checked = false);
            updateCalc();
        }

        function handleCertSelect(el, id) { if (el.checked) document.getElementById(`noCertCheck_${id}`).checked = false; updateCalc(); }

        function toggleIndefinite(el) {
            const date = el.closest('.item-row').querySelector('.cert-date');
            date.disabled = el.checked; if (el.checked) date.value = ""; updateCalc();
        }

        function updateCalc() {
            const today = new Date(); today.setHours(0,0,0,0);
            let total = 0;
            CONFIG.forEach(cat => {
                let catMax = 0, winner = null;
                const rows = document.querySelectorAll(`.cert-item-${cat.id}`), isNoCert = document.getElementById(`noCertCheck_${cat.id}`).checked;
                document.getElementById(`noCertBox_${cat.id}`).classList.toggle('no-cert-active', isNoCert);
                if (isNoCert) { rows.forEach(r => { r.classList.add('opacity-30'); r.classList.remove('highest-glow'); }); }
                else {
                    rows.forEach(row => {
                        const check = row.querySelector('.cert-check').checked, dateIn = row.querySelector('.cert-date'), isPerm = row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked;
                        row.classList.remove('highest-glow', 'opacity-30');
                        if (check) {
                            let valid = true;
                            if (dateIn && !isPerm) { if (!dateIn.value || new Date(dateIn.value) < today) valid = false; }
                            if (valid && parseFloat(row.dataset.score) > catMax) { catMax = parseFloat(row.dataset.score); winner = row; }
                        }
                    });
                    if (winner) rows.forEach(r => { if(r === winner) r.classList.add('highest-glow'); else if(r.querySelector('.cert-check').checked) r.classList.add('opacity-30'); });
                }
                total += catMax;
            });
            document.getElementById('floatingScore').innerText = total.toFixed(2);
        }

        async function prepareConfirmation() {
            const bigVal = document.getElementById('bigBrigade').value, name = document.getElementById('name').value;
            if (!name || !bigVal) return alert("基本資料未填寫完整！");
            if (bigVal === "局本部" && !document.getElementById('hqDept').value) return alert("請輸入科室名稱！");
            if (bigVal !== "局本部" && !document.getElementById('smallUnit').value) return alert("請選擇分隊！");

            const list = document.getElementById('confirmList'); list.innerHTML = "";
            let finalTotal = 0, stop = false;

            CONFIG.forEach(cat => {
                let best = { name: "無相關證照", score: 0 };
                if (!document.getElementById(`noCertCheck_${cat.id}`).checked) {
                    document.querySelectorAll(`.cert-item-${cat.id}`).forEach(row => {
                        if (row.querySelector('.cert-check').checked) {
                            if (row.querySelector('.cert-file').files.length === 0) { alert(`【${cat.title}】勾選了項目但未上傳檔案！`); stop = true; return; }
                            const score = parseFloat(row.dataset.score);
                            if (score > best.score) best = { name: row.dataset.name, score: score };
                        }
                    });
                }
                if (stop) return;
                list.innerHTML += `<div class="flex justify-between p-4 bg-slate-50 rounded-2xl mb-2 text-sm"><span>${cat.title}: <b>${best.name}</b></span><span class="text-blue-600 font-black">+${best.score.toFixed(2)}</span></div>`;
                finalTotal += best.score;
            });
            if (stop) return;
            document.getElementById('modalTotal').innerText = finalTotal.toFixed(2);
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function submitToGas() {
            const btn = document.getElementById('finalSubmitBtn'); btn.disabled = true; btn.innerText = "傳送中...";
            const payload = {
                idCard: document.getElementById('idCard').value, name: document.getElementById('name').value,
                bigBrigade: document.getElementById('bigBrigade').value, hqDept: document.getElementById('hqDept').value,
                medBrigade: document.getElementById('medBrigade').value, smallUnit: document.getElementById('smallUnit').value,
                certificates: []
            };
            const selected = document.querySelectorAll('.cert-check:checked');
            for (let check of selected) {
                const row = check.closest('.item-row'), file = row.querySelector('.cert-file').files[0], dateIn = row.querySelector('.cert-date');
                const isPerm = row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked;
                payload.certificates.push({
                    category: row.dataset.cat, itemName: row.dataset.name, score: row.dataset.score,
                    expiry: isPerm ? "無期限" : (dateIn ? dateIn.value : "永久有效"),
                    fileBase64: await toBase64(file), fileName: file.name
                });
            }

            const GAS_URL = "你的GAS佈署網址"; 
            try {
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.result === "success") { alert("申報完成！"); location.reload(); } else alert("發生錯誤：" + json.message);
            } catch(e) { alert("連線失敗"); }
            btn.disabled = false; btn.innerText = "確認送出";
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
        });

        initForm();
    </script>
</body>
</html>
