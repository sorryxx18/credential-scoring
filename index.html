<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業技術能力積分申報系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: linear-gradient(135deg, #f1f5f9 0%, #cbd5e1 100%); min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 1.5rem; border: 1px solid rgba(255, 255, 255, 0.4); }
        .item-row { transition: all 0.3s ease; border: 2px solid transparent; }
        .highest-glow { border-color: #2563eb; background: #eff6ff; box-shadow: 0 10px 20px -5px rgba(37, 99, 235, 0.15); }
        .badge-permanent { color: #059669; font-weight: bold; font-size: 0.7rem; background: #ecfdf5; padding: 2px 10px; border-radius: 999px; border: 1px solid #10b981; }
        input[type="date"]:disabled { background-color: #f1f5f9; color: #94a3b8; cursor: not-allowed; }
    </style>
</head>
<body class="p-4 md:p-10 text-slate-800">

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-end mb-12 gap-4 border-b-2 border-slate-300 pb-6">
            <div>
                <h1 class="text-4xl font-black text-slate-800 tracking-tight">專業技術積分申報</h1>
                <p class="text-slate-500 font-medium mt-1">Professional Skills Evaluation & Reporting</p>
            </div>
            <div class="text-right">
                <div class="bg-slate-800 text-white px-4 py-1 rounded-lg text-xs font-bold inline-block mb-1">台北市政府消防局標準</div>
                <p class="text-slate-400 text-xs font-bold">系統版本：2024.V1</p>
            </div>
        </header>

        <!-- 邏輯說明卡 -->
        <div class="glass-card p-8 mb-10 shadow-xl grid md:grid-cols-3 gap-8 relative overflow-hidden">
            <div class="md:col-span-2">
                <h2 class="text-xl font-bold text-blue-700 mb-4 flex items-center">
                    <i class="fa-solid fa-clipboard-check mr-2"></i> 申報與計分邏輯
                </h2>
                <ul class="space-y-3 text-sm text-slate-600">
                    <li class="flex items-start gap-2">
                        <i class="fa-solid fa-1 text-blue-500 mt-1"></i>
                        <span><strong>類別擇優：</strong> 同一區塊（如：水上救生）內若擁有多張證照，系統自動採計<strong>分數最高</strong>者。</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa-solid fa-2 text-blue-500 mt-1"></i>
                        <span><strong>效期限制：</strong> 除救生員證可自選期限外，其餘證照皆視為永久有效。</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa-solid fa-3 text-blue-500 mt-1"></i>
                        <span><strong>佐證上傳：</strong> 所有勾選項目必須上傳證照檔案，否則該項不予計分。</span>
                    </li>
                </ul>
            </div>
            <div class="bg-blue-50 rounded-2xl p-6 flex flex-col justify-center items-center text-center">
                <i class="fa-solid fa-calculator text-blue-200 text-5xl mb-2"></i>
                <p class="text-xs text-blue-800 font-bold mb-1 italic">即時預估總積分</p>
                <span id="floatingScore" class="text-5xl font-black text-blue-600">0.00</span>
            </div>
        </div>

        <!-- 基本資料 -->
        <section class="glass-card p-8 shadow-lg mb-10 border-t-8 border-blue-600">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div>
                    <label class="block text-xs font-black text-slate-400 mb-2 tracking-widest uppercase">身分證字號</label>
                    <input type="text" id="idCard" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none transition-all" placeholder="E123456789">
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-400 mb-2 tracking-widest uppercase">姓名</label>
                    <input type="text" id="name" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none transition-all" placeholder="請填寫中文全名">
                </div>
                <div>
                    <label class="block text-xs font-black text-slate-400 mb-2 tracking-widest uppercase">服務單位</label>
                    <input type="text" id="unit" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none transition-all" placeholder="例如：大安分隊">
                </div>
            </div>
        </section>

        <!-- 證照區域 -->
        <div id="mainForm" class="space-y-12">
            <!-- 由 JS 動態生成項目 -->
        </div>

        <!-- 提交按鈕 -->
        <div class="mt-16 mb-32 flex flex-col items-center">
            <button onclick="prepareConfirmation()" class="group bg-blue-600 hover:bg-slate-900 text-white px-20 py-5 rounded-3xl font-black text-xl shadow-2xl transition-all hover:-translate-y-1 active:scale-95">
                <i class="fa-solid fa-magnifying-glass-chart mr-2"></i> 生成試算預覽
            </button>
            <p class="mt-6 text-slate-400 text-sm">點擊按鈕後，將彈出視窗確認各區採計結果</p>
        </div>
    </div>

    <!-- 試算確認彈窗 (Modal) -->
    <div id="modal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[3rem] shadow-2xl overflow-hidden">
            <div class="bg-blue-600 p-10 text-white text-center">
                <h3 class="text-3xl font-black italic mb-2 tracking-tighter">PREVIEW REPORT</h3>
                <p class="text-blue-100 text-sm">系統已自動根據擇優與效期規則產出以下結果：</p>
            </div>
            <div class="p-10">
                <div id="confirmList" class="space-y-4 mb-8">
                    <!-- 試算清單 -->
                </div>
                <div class="flex justify-between items-center bg-slate-50 p-6 rounded-3xl mb-8 border-2 border-dashed border-slate-200">
                    <span class="text-slate-500 font-bold">預計總積分：</span>
                    <span id="modalTotal" class="text-5xl font-black text-blue-600">0.00</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="closeModal()" class="py-5 text-slate-400 font-bold hover:bg-slate-50 rounded-2xl transition">返回修改</button>
                    <button id="finalSubmitBtn" onclick="submitToGas()" class="py-5 bg-blue-600 text-white font-bold rounded-2xl shadow-xl hover:bg-blue-700 transition">確定無誤送出</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 配置資料：只有救生員有 hasExpiry
        const CONFIG = [
            {
                id: "water",
                title: "水上救生",
                items: [
                    { name: "救生員", score: 0.35, hasExpiry: true },
                    { name: "救生教練", score: 0.56, hasExpiry: false }
                ]
            },
            {
                id: "swift",
                title: "急流救援",
                items: [
                    { name: "急流救援訓練(40小時)", score: 0.56, hasExpiry: false },
                    { name: "急流救援訓練教官班(45小時)", score: 0.70, hasExpiry: false }
                ]
            },
            {
                id: "dive",
                title: "潛水救援",
                items: [
                    { name: "救援潛水", score: 0.56, hasExpiry: false },
                    { name: "潛水教官", score: 0.70, hasExpiry: false },
                    { name: "公共安全潛水(82小時)", score: 0.70, hasExpiry: false }
                ]
            },
            {
                id: "drive",
                title: "車輛駕駛",
                items: [
                    { name: "大貨(客)車駕照", score: 0.70, hasExpiry: false },
                    { name: "聯結車駕照", score: 1.05, hasExpiry: false }
                ]
            }
        ];

        function init() {
            const container = document.getElementById('mainForm');
            CONFIG.forEach(cat => {
                let html = `
                    <div class="glass-card overflow-hidden shadow-lg border-b-4 border-blue-100">
                        <div class="bg-slate-50 px-8 py-4 border-b flex justify-between items-center">
                            <span class="font-black text-slate-400 text-xs tracking-widest uppercase">${cat.title}</span>
                            <span class="badge-permanent">擇優取一項</span>
                        </div>
                        <div class="p-4 md:p-8 space-y-6">
                `;
                
                cat.items.forEach(item => {
                    html += `
                        <div class="item-row p-5 rounded-3xl bg-white border-2 border-slate-50" data-cat="${cat.id}" data-score="${item.score}" data-name="${item.name}">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                                <div class="flex items-center gap-4">
                                    <input type="checkbox" onchange="updateCalc()" class="w-8 h-8 rounded-xl text-blue-600 cert-check cursor-pointer focus:ring-0">
                                    <div>
                                        <h4 class="font-bold text-slate-800">${item.name}</h4>
                                        <p class="text-blue-500 font-black text-sm tracking-widest">+ ${item.score.toFixed(2)}</p>
                                    </div>
                                </div>
                                <div class="flex flex-wrap items-center gap-6">
                                    <div class="flex flex-col min-w-[160px]">
                                        <span class="text-[10px] font-black text-slate-300 uppercase mb-1">有效期限</span>
                                        ${item.hasExpiry ? `
                                            <div class="flex items-center gap-2">
                                                <input type="date" onchange="updateCalc()" class="cert-date border-2 border-slate-100 rounded-lg p-1 text-xs outline-none focus:border-blue-400 transition">
                                                <label class="flex items-center gap-1 text-[10px] text-slate-500 cursor-pointer">
                                                    <input type="checkbox" onchange="toggleDate(this)" class="no-expiry-check"> 無期限
                                                </label>
                                            </div>
                                        ` : `<div class="badge-permanent">永久有效</div>`}
                                    </div>
                                    <div class="flex flex-col">
                                        <span class="text-[10px] font-black text-slate-300 uppercase mb-1">佐證檔案</span>
                                        <input type="file" onchange="updateCalc()" class="cert-file text-[10px] w-40 text-slate-400 file:mr-3 file:py-1 file:px-3 file:rounded-full file:border-0 file:bg-slate-100 file:text-slate-600 hover:file:bg-blue-50">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            });
            updateCalc();
        }

        // 切換無期限選項
        function toggleDate(el) {
            const dateInput = el.closest('.item-row').querySelector('.cert-date');
            dateInput.disabled = el.checked;
            if (el.checked) dateInput.value = "";
            updateCalc();
        }

        function updateCalc() {
            const today = new Date();
            today.setHours(0,0,0,0);
            let total = 0;

            CONFIG.forEach(cat => {
                let catMax = 0;
                let catWinner = null;
                const rows = document.querySelectorAll(`.item-row[data-cat="${cat.id}"]`);
                
                rows.forEach(row => {
                    const isChecked = row.querySelector('.cert-check').checked;
                    const dateInput = row.querySelector('.cert-date');
                    const noExpiry = row.querySelector('.no-expiry-check')?.checked;
                    const score = parseFloat(row.dataset.score);
                    
                    row.classList.remove('highest-glow', 'opacity-30');
                    
                    if (isChecked) {
                        let valid = true;
                        // 只有救生員需要檢查日期且非「無期限」
                        if (dateInput && !noExpiry) {
                            const date = new Date(dateInput.value);
                            if (!dateInput.value || date < today) {
                                valid = false;
                                dateInput.style.borderColor = "#f87171";
                            } else {
                                dateInput.style.borderColor = "#3b82f6";
                            }
                        }

                        if (valid && score > catMax) {
                            catMax = score;
                            catWinner = row;
                        }
                    }
                });

                if (catWinner) {
                    rows.forEach(row => {
                        if (row === catWinner) row.classList.add('highest-glow');
                        else if (row.querySelector('.cert-check').checked) row.classList.add('opacity-30');
                    });
                }
                total += catMax;
            });
            document.getElementById('floatingScore').innerText = total.toFixed(2);
        }

        function prepareConfirmation() {
            const name = document.getElementById('name').value;
            if(!name) return alert("請填寫姓名！");

            const list = document.getElementById('confirmList');
            list.innerHTML = "";
            let finalTotal = 0;
            const today = new Date();
            today.setHours(0,0,0,0);

            CONFIG.forEach(cat => {
                let best = { name: "未持有或無有效證照", score: 0 };
                document.querySelectorAll(`.item-row[data-cat="${cat.id}"]`).forEach(row => {
                    const isChecked = row.querySelector('.cert-check').checked;
                    const dateInput = row.querySelector('.cert-date');
                    const noExpiry = row.querySelector('.no-expiry-check')?.checked;
                    const score = parseFloat(row.dataset.score);

                    let valid = true;
                    if (isChecked) {
                        if (dateInput && !noExpiry) {
                            if (!dateInput.value || new Date(dateInput.value) < today) valid = false;
                        }
                        if (valid && score > best.score) {
                            best = { name: row.dataset.name, score: score };
                        }
                    }
                });

                list.innerHTML += `
                    <div class="flex justify-between items-center p-5 bg-slate-50 rounded-2xl border border-slate-100">
                        <div>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest">${cat.title}</p>
                            <p class="font-bold text-slate-700">${best.name}</p>
                        </div>
                        <p class="text-xl font-black text-blue-600">+${best.score.toFixed(2)}</p>
                    </div>
                `;
                finalTotal += best.score;
            });

            document.getElementById('modalTotal').innerText = finalTotal.toFixed(2);
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function submitToGas() {
            const btn = document.getElementById('finalSubmitBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>傳送中...';

            const payload = {
                idCard: document.getElementById('idCard').value,
                name: document.getElementById('name').value,
                unit: document.getElementById('unit').value,
                certificates: []
            };

            for (let check of document.querySelectorAll('.cert-check:checked')) {
                const row = check.closest('.item-row');
                const fileInput = row.querySelector('.cert-file');
                const dateInput = row.querySelector('.cert-date');
                const noExpiry = row.querySelector('.no-expiry-check')?.checked;

                const fileData = fileInput.files[0] ? await toBase64(fileInput.files[0]) : null;

                payload.certificates.push({
                    category: row.dataset.cat,
                    itemName: row.dataset.name,
                    score: row.dataset.score,
                    expiryDate: noExpiry ? "無期限" : (dateInput ? dateInput.value : "永久有效"),
                    fileName: fileInput.files[0]?.name || "",
                    fileBase64: fileData
                });
            }

            const GAS_URL = "你的GAS佈署網址"; 
            try {
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
                const json = await res.json();
                if(json.result === "success") { alert("申報成功！"); location.reload(); }
                else { alert("錯誤：" + json.message); }
            } catch(e) { alert("連線失敗"); }
            btn.disabled = false;
            btn.innerText = "確認無誤送出";
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
        });

        init();
    </script>
</body>
</html>
