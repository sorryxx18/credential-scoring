<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業技術能力積分申報系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f1f5f9; min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 2rem; border: 1px solid rgba(255, 255, 255, 0.5); }
        .item-row { transition: all 0.3s ease; border: 2px solid transparent; }
        .highest-glow { border-color: #2563eb; background: #eff6ff; box-shadow: 0 10px 15px -5px rgba(37, 99, 235, 0.1); }
        .no-cert-card { background: #f8fafc; border: 2px dashed #cbd5e1; }
        .no-cert-active { background: #f1f5f9; border-color: #94a3b8; opacity: 0.8; }
        .select-custom { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; }
    </style>
</head>
<body class="p-4 md:p-10 text-slate-800">

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-6">
            <div class="flex items-center gap-4">
                <div class="bg-blue-600 p-4 rounded-3xl shadow-xl text-white">
                    <i class="fa-solid fa-fire-extinguisher text-3xl"></i>
                </div>
                <div>
                    <h1 class="text-3xl font-black text-slate-800 tracking-tight">專業技術積分申報</h1>
                    <p class="text-slate-500 font-bold italic underline decoration-blue-500 underline-offset-4">Professional Skill Assessment</p>
                </div>
            </div>
            <div class="bg-white px-6 py-2 rounded-2xl shadow-sm border border-slate-200 text-center">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-none mb-1">Bureau Info</p>
                <p class="text-blue-700 font-black">臺北市政府消防局</p>
            </div>
        </header>

        <!-- 申報須知 -->
        <div class="glass-card p-8 mb-10 shadow-xl relative overflow-hidden">
            <h2 class="text-xl font-black text-slate-800 mb-4 flex items-center italic">
                <i class="fa-solid fa-circle-exclamation text-blue-600 mr-2"></i> 申報邏輯與說明
            </h2>
            <div class="grid md:grid-cols-2 gap-6 text-sm text-slate-600 leading-relaxed font-medium">
                <p class="flex items-start gap-2"><i class="fa-solid fa-check-circle text-blue-500 mt-1"></i> <strong>擇優計分：</strong> 每個類別自動計算有效且最高分之一項。</p>
                <p class="flex items-start gap-2"><i class="fa-solid fa-check-circle text-blue-500 mt-1"></i> <strong>日期規定：</strong> 僅救生員需填寫到期日，過期則不予計分。</p>
            </div>
        </div>

        <!-- 基本資料與單位選擇 -->
        <section class="glass-card p-10 shadow-xl mb-10 border-t-8 border-slate-800">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">身分證字號</label>
                    <input type="text" id="idCard" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none" placeholder="A123456789">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">姓名</label>
                    <input type="text" id="name" class="w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none" placeholder="全名">
                </div>
                <div class="lg:col-span-2">
                    <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">所屬機關/大隊</label>
                    <select id="bigBrigade" onchange="toggleUnitUI()" class="select-custom w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none font-bold">
                        <option value="">請選擇</option>
                        <option value="局本部">局本部 (各科、室、中心)</option>
                        <option value="第一大隊">第一大隊</option>
                        <option value="第二大隊">第二大隊</option>
                        <option value="第三大隊">第三大隊</option>
                        <option value="第四大隊">第四大隊</option>
                    </select>
                </div>

                <!-- 局本部專用輸入框 (預設隱藏) -->
                <div id="hqArea" class="lg:col-span-4 hidden animate-pulse">
                    <label class="block text-[10px] font-black text-blue-600 mb-2 uppercase tracking-widest">局本部科室名稱</label>
                    <input type="text" id="hqDept" class="w-full bg-blue-50 border-2 border-blue-200 rounded-xl p-3 focus:border-blue-500 outline-none placeholder-blue-300" placeholder="例如：人事室、救護科、火調科...">
                </div>

                <!-- 大隊連動選單 (預設隱藏) -->
                <div id="brigadeArea" class="lg:col-span-4 grid grid-cols-1 md:grid-cols-2 gap-8 hidden">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">所屬中隊</label>
                        <select id="medBrigade" onchange="updateSmall()" class="select-custom w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none"></select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 mb-2 uppercase tracking-widest">所屬分隊 / 本部</label>
                        <select id="smallUnit" class="select-custom w-full bg-slate-50 border-2 border-slate-100 rounded-xl p-3 focus:border-blue-500 outline-none"></select>
                    </div>
                </div>
            </div>
        </section>

        <!-- 證照填寫區域 -->
        <div id="mainForm" class="space-y-12">
            <!-- JS 生成 -->
        </div>

        <!-- 提交按鈕 -->
        <div class="mt-20 mb-32 flex flex-col items-center">
            <button onclick="prepareConfirmation()" class="group bg-slate-900 hover:bg-blue-700 text-white px-20 py-5 rounded-[2.5rem] font-black text-xl shadow-2xl transition-all hover:-translate-y-1 active:scale-95">
                <i class="fa-solid fa-calculator mr-2 group-hover:rotate-12 transition inline-block"></i> 進入試算預覽
            </button>
            <p class="mt-4 text-slate-400 text-xs font-bold uppercase tracking-widest">Check all details before submitting</p>
        </div>
    </div>

    <!-- 懸浮計分板 -->
    <div class="fixed bottom-10 right-10 z-40">
        <div class="bg-white/90 backdrop-blur px-8 py-5 rounded-[2rem] shadow-2xl border-4 border-blue-600 flex flex-col items-center">
            <span class="text-[10px] font-black text-blue-600 uppercase tracking-tighter">Current Score</span>
            <span id="floatingScore" class="text-4xl font-black text-slate-800 tracking-tighter">0.00</span>
        </div>
    </div>

    <!-- 預覽彈窗 -->
    <div id="modal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xl rounded-[3rem] shadow-2xl overflow-hidden scale-in transition-all">
            <div class="bg-slate-50 p-10 border-b flex justify-between items-center">
                <div>
                    <h3 class="text-3xl font-black text-slate-800 italic tracking-tighter">PREVIEW</h3>
                    <p class="text-slate-500 font-bold">積分試算對帳單</p>
                </div>
                <div class="text-6xl text-slate-200 font-black italic">#01</div>
            </div>
            <div class="p-10">
                <div id="confirmList" class="space-y-4 mb-10"></div>
                <div class="flex justify-between items-center bg-blue-50 p-8 rounded-[2.5rem] mb-10 border-2 border-blue-100">
                    <span class="text-blue-800 font-black italic tracking-widest">TOTAL POINTS</span>
                    <span id="modalTotal" class="text-5xl font-black text-blue-600">0.00</span>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <button onclick="closeModal()" class="py-5 text-slate-400 font-bold hover:bg-slate-50 rounded-2xl transition">返回修改</button>
                    <button id="finalSubmitBtn" onclick="submitToGas()" class="py-5 bg-blue-600 text-white font-bold rounded-2xl shadow-xl hover:bg-blue-700 transition">確定送出</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 單位資料
        const AUDIT_UNITS = {
            "第一大隊": {
                "本部": ["第一救災救護大隊"],
                "中正中隊": ["中正中隊", "華山分隊", "泉州分隊", "古亭分隊", "城中分隊"], 
                "萬華中隊": ["萬華中隊", "雙園分隊", "龍山分隊"],
                "文山中隊": ["文山中隊", "萬芳分隊", "景美分隊", "木柵分隊", "寶橋分隊"]
            },
            "第二大隊": {
                "本部": ["第二救災救護大隊"],
                "大安中隊": ["大安中隊", "金華分隊", "復興分隊", "安和分隊"],
                "信義中隊": ["信義中隊", "信義分隊", "莊敬分隊"], 
                "南港中隊": ["南港中隊", "南港分隊", "舊莊分隊", "成德分隊"]
            },
            "第三大隊": {
                "本部": ["第三救災救護大隊"],
                "中山中隊": ["中山中隊", "大直分隊", "圓山分隊", "松江分隊"], 
                "松山中隊": ["松山中隊", "中崙分隊", "八德分隊"],
                "內湖中隊": ["內湖中隊", "民權分隊", "內湖分隊", "大湖分隊", "東湖分隊"]
            },
            "第四大隊": {
                "本部": ["第四救災救護大隊"],
                "大同中隊": ["大同中隊", "建成分隊", "延平分隊", "大同分隊"],
                "士林中隊": ["士林中隊", "山仔后分隊", "天母分隊", "福安分隊", "社子分隊", "劍潭分隊", "雙溪分隊"], 
                "北投中隊": ["北投中隊", "陽明山分隊", "光明分隊", "關渡分隊", "石牌分隊", "秀山分隊"]
            }
        };

        const CONFIG = [
            { id: "water", title: "水上救生類", items: [{ name: "救生員", score: 0.35, hasDate: true }, { name: "救生教練", score: 0.56, hasDate: false }] },
            { id: "swift", title: "急流救援類", items: [{ name: "急流救援訓練(40小時)", score: 0.56, hasDate: false }, { name: "急流教官班(45小時)", score: 0.70, hasDate: false }] },
            { id: "dive", title: "潛水救援類", items: [{ name: "救援潛水", score: 0.56, hasDate: false }, { name: "潛水教官", score: 0.70, hasDate: false }, { name: "公共安全潛水(82小時)", score: 0.70, hasDate: false }] },
            { id: "drive", title: "車輛駕駛類", items: [{ name: "大貨(客)車駕照", score: 0.70, hasDate: false }, { name: "聯結車駕照", score: 1.05, hasDate: false }] }
        ];

        // 單位切換顯示
        function toggleUnitUI() {
            const bigVal = document.getElementById('bigBrigade').value;
            const hqArea = document.getElementById('hqArea');
            const brArea = document.getElementById('brigadeArea');

            if (bigVal === "局本部") {
                hqArea.classList.remove('hidden');
                brArea.classList.add('hidden');
            } else if (bigVal && bigVal !== "局本部") {
                hqArea.classList.add('hidden');
                brArea.classList.remove('hidden');
                updateMedium(bigVal);
            } else {
                hqArea.classList.add('hidden');
                brArea.classList.add('hidden');
            }
        }

        function updateMedium(bigVal) {
            const med = document.getElementById('medBrigade');
            med.innerHTML = '<option value="">請選擇中隊</option>';
            document.getElementById('smallUnit').innerHTML = '<option value="">請選擇分隊</option>';
            if (AUDIT_UNITS[bigVal]) {
                for (let m in AUDIT_UNITS[bigVal]) {
                    med.options.add(new Option(m, m));
                }
            }
        }

        function updateSmall() {
            const bigVal = document.getElementById('bigBrigade').value;
            const medVal = document.getElementById('medBrigade').value;
            const unit = document.getElementById('smallUnit');
            unit.innerHTML = '<option value="">請選擇分隊</option>';
            if (bigVal && medVal && AUDIT_UNITS[bigVal][medVal]) {
                AUDIT_UNITS[bigVal][medVal].forEach(u => unit.options.add(new Option(u, u)));
            }
        }

        // 初始化表單
        function initForm() {
            const container = document.getElementById('mainForm');
            CONFIG.forEach(cat => {
                let html = `
                    <div class="glass-card overflow-hidden shadow-lg border-l-[12px] border-slate-200 hover:border-blue-500 transition-all">
                        <div class="bg-slate-50 px-8 py-5 border-b flex justify-between items-center">
                            <h3 class="font-black text-slate-400 text-xs tracking-widest uppercase italic">${cat.title}</h3>
                            <span class="text-[10px] font-black text-blue-500 bg-blue-50 px-3 py-1 rounded-full border border-blue-100 uppercase">Picked Highest</span>
                        </div>
                        <div class="p-4 md:p-8 space-y-6">
                            <!-- 無相關證照卡片 -->
                            <div class="no-cert-card p-6 rounded-3xl flex items-center justify-between cursor-pointer hover:shadow-inner transition" onclick="toggleNoCert('${cat.id}')" id="noCertBox_${cat.id}">
                                <div class="flex items-center gap-4">
                                    <input type="checkbox" id="noCertCheck_${cat.id}" class="w-8 h-8 rounded-xl border-slate-300 text-slate-600 focus:ring-0" onchange="toggleNoCert('${cat.id}')">
                                    <div>
                                        <p class="font-black text-slate-700">無相關證照 / 暫不申報</p>
                                        <p class="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">I don't have a certificate in this category</p>
                                    </div>
                                </div>
                                <span class="text-xs font-black text-slate-300 italic">0.00 pts</span>
                            </div>
                `;
                cat.items.forEach(item => {
                    html += `
                        <div class="item-row p-6 rounded-[2.5rem] bg-white border-2 border-slate-50 flex flex-col md:flex-row md:items-center justify-between gap-6 cert-item-${cat.id}" data-cat="${cat.id}" data-score="${item.score}" data-name="${item.name}">
                            <div class="flex items-center gap-4">
                                <input type="checkbox" onchange="handleCertSelect(this, '${cat.id}')" class="w-8 h-8 rounded-xl text-blue-600 cert-check cursor-pointer focus:ring-0">
                                <div>
                                    <h4 class="font-bold text-slate-800 text-lg">${item.name}</h4>
                                    <p class="text-blue-500 font-black text-sm tracking-tighter italic">+ ${item.score.toFixed(2)} Points</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap items-center gap-6">
                                <div class="flex flex-col min-w-[160px]">
                                    <span class="text-[10px] font-black text-slate-300 uppercase mb-1 tracking-widest">Validity</span>
                                    ${item.hasDate ? `
                                        <div class="flex items-center gap-2">
                                            <input type="date" onchange="updateCalc()" class="cert-date border-2 border-slate-100 rounded-xl p-2 text-xs focus:border-blue-400 transition-all outline-none">
                                            <label class="text-[10px] flex items-center gap-1 font-bold text-slate-400 cursor-pointer"><input type="checkbox" onchange="toggleIndefinite(this)"> 永久</label>
                                        </div>` : `<div class="text-[10px] font-black text-green-600 bg-green-50 px-3 py-1 rounded-full border border-green-200 inline-block">永久有效 / PERMANENT</div>`}
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-[10px] font-black text-slate-300 uppercase mb-1 tracking-widest">Evidence</span>
                                    <input type="file" onchange="updateCalc()" class="cert-file text-[10px] w-40 text-slate-400 file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-slate-100 file:text-slate-600 hover:file:bg-blue-50">
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML += html + `</div></div>`;
            });
            updateCalc();
        }

        // 切換無相關證照邏輯
        function toggleNoCert(catId) {
            if (event.target.type !== 'checkbox') {
                document.getElementById(`noCertCheck_${catId}`).checked = !document.getElementById(`noCertCheck_${catId}`).checked;
            }
            const isChecked = document.getElementById(`noCertCheck_${catId}`).checked;
            if (isChecked) {
                // 取消所有該類別證照的勾選
                document.querySelectorAll(`.cert-item-${catId} .cert-check`).forEach(c => c.checked = false);
            }
            updateCalc();
        }

        // 勾選證照時自動取消無相關證照
        function handleCertSelect(el, catId) {
            if (el.checked) {
                document.getElementById(`noCertCheck_${catId}`).checked = false;
            }
            updateCalc();
        }

        function toggleIndefinite(el) {
            const dateInput = el.closest('.item-row').querySelector('.cert-date');
            dateInput.disabled = el.checked;
            if (el.checked) dateInput.value = "";
            updateCalc();
        }

        function updateCalc() {
            const today = new Date(); today.setHours(0,0,0,0);
            let total = 0;

            CONFIG.forEach(cat => {
                let catMax = 0; let winner = null;
                const rows = document.querySelectorAll(`.cert-item-${cat.id}`);
                const isNoCert = document.getElementById(`noCertCheck_${cat.id}`).checked;
                const box = document.getElementById(`noCertBox_${cat.id}`);

                box.classList.remove('no-cert-active');
                if (isNoCert) {
                    box.classList.add('no-cert-active');
                    rows.forEach(r => { r.classList.add('opacity-30'); r.classList.remove('highest-glow'); });
                } else {
                    rows.forEach(row => {
                        const isChecked = row.querySelector('.cert-check').checked;
                        const dateInput = row.querySelector('.cert-date');
                        const isPerm = row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked;
                        row.classList.remove('highest-glow', 'opacity-30');
                        if (isChecked) {
                            let valid = true;
                            if (dateInput && !isPerm) {
                                if (!dateInput.value || new Date(dateInput.value) < today) valid = false;
                            }
                            if (valid && parseFloat(row.dataset.score) > catMax) {
                                catMax = parseFloat(row.dataset.score); winner = row;
                            }
                        }
                    });
                    if (winner) {
                        rows.forEach(r => { if(r === winner) r.classList.add('highest-glow'); else if(r.querySelector('.cert-check').checked) r.classList.add('opacity-30'); });
                    }
                }
                total += catMax;
            });
            document.getElementById('floatingScore').innerText = total.toFixed(2);
        }

        function prepareConfirmation() {
            const bigVal = document.getElementById('bigBrigade').value;
            const hqVal = document.getElementById('hqDept').value;
            const smallVal = document.getElementById('smallUnit').value;
            const name = document.getElementById('name').value;

            if (!name) return alert("請填寫姓名！");
            if (!bigVal) return alert("請選擇所屬大隊或局本部！");
            if (bigVal === "局本部" && !hqVal) return alert("請填寫局本部科室名稱！");
            if (bigVal !== "局本部" && !smallVal) return alert("請選擇所屬分隊！");

            const list = document.getElementById('confirmList'); list.innerHTML = "";
            let finalTotal = 0;

            CONFIG.forEach(cat => {
                let best = { name: "無相關證照", score: 0 };
                if (!document.getElementById(`noCertCheck_${cat.id}`).checked) {
                    document.querySelectorAll(`.cert-item-${cat.id}`).forEach(row => {
                        if (row.querySelector('.cert-check').checked) {
                            const dateInput = row.querySelector('.cert-date');
                            const isPerm = row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked;
                            let valid = true;
                            if (dateInput && !isPerm) {
                                if (!dateInput.value || new Date(dateInput.value) < new Date().setHours(0,0,0,0)) valid = false;
                            }
                            if (valid && parseFloat(row.dataset.score) > best.score) best = { name: row.dataset.name, score: parseFloat(row.dataset.score) };
                        }
                    });
                }
                list.innerHTML += `<div class="flex justify-between items-center p-5 bg-slate-50 rounded-2xl border border-slate-100"><div><p class="text-[10px] font-black text-slate-300 uppercase">${cat.title}</p><p class="font-bold text-slate-700">${best.name}</p></div><p class="text-xl font-black text-blue-600">+${best.score.toFixed(2)}</p></div>`;
                finalTotal += best.score;
            });

            document.getElementById('modalTotal').innerText = finalTotal.toFixed(2);
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function submitToGas() {
            const btn = document.getElementById('finalSubmitBtn'); btn.disabled = true; btn.innerText = "UPLOADING...";
            const payload = {
                idCard: document.getElementById('idCard').value,
                name: document.getElementById('name').value,
                bigBrigade: document.getElementById('bigBrigade').value,
                hqDept: document.getElementById('hqDept').value,
                medBrigade: document.getElementById('medBrigade').value,
                smallUnit: document.getElementById('smallUnit').value,
                certificates: []
            };

            for (let check of document.querySelectorAll('.cert-check:checked')) {
                const row = check.closest('.item-row');
                const file = row.querySelector('.cert-file').files[0];
                payload.certificates.push({
                    category: row.dataset.cat, itemName: row.dataset.name, score: row.dataset.score,
                    expiry: row.querySelector('.cert-date')?.value || (row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked ? "永久" : "永久"),
                    fileBase64: file ? await toBase64(file) : null
                });
            }

            const GAS_URL = "https://script.google.com/macros/s/AKfycbxMK3Z5shYYs_7_2k1qe0TfZ1uC0rMUufwatzuF3jc6SCH0L_PA-jcgmqG_fPW2BI5vBQ/exec";
            try {
                const res = await fetch(GAS_URL, { method: "POST", body: JSON.stringify(payload) });
                const json = await res.json();
                if (json.result === "success") { alert("申報完成！"); location.reload(); } else { alert("失敗：" + json.message); }
            } catch(e) { alert("連線失敗，請檢查網路。"); }
            btn.disabled = false; btn.innerText = "確認送出";
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
        });

        initForm();
    </script>
</body>
</html>
