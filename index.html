<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>專業技術能力積分申報系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background: #f0f2f5; min-height: 100vh; }
        .glass-card { background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 1.5rem; box-shadow: 0 10px 30px -5px rgba(0,0,0,0.05); }
        .item-row { transition: all 0.2s ease; border: 2px solid #f1f5f9; }
        .highest-glow { border-color: #3b82f6 !important; background: #eff6ff; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.1); }
        .no-cert-active { border-color: #cbd5e1 !important; background: #f8fafc; opacity: 0.7; }
        .select-custom { appearance: none; background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 1.5em 1.5em; }
    </style>
</head>
<body class="p-4 md:p-10">

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">專業技術能力積分申報</h1>
                <p class="text-slate-500 font-medium italic">Professional Skills Evaluator</p>
            </div>
            <div class="bg-blue-600 text-white px-6 py-2 rounded-2xl shadow-lg font-bold">
                臺北市政府消防局
            </div>
        </header>

        <!-- 引導區 -->
        <div class="glass-card p-6 mb-8 border-l-8 border-blue-600 shadow-sm">
            <h2 class="font-bold text-slate-800 mb-2 flex items-center">
                <i class="fa-solid fa-circle-info text-blue-600 mr-2"></i> 系統申報須知
            </h2>
            <div class="grid md:grid-cols-2 gap-4 text-xs text-slate-500 leading-relaxed">
                <p><i class="fa-solid fa-check text-blue-500 mr-1"></i> <strong>擇優原則：</strong> 每個類別自動選取「有效且分數最高」之一項證照計分。</p>
                <p><i class="fa-solid fa-check text-blue-500 mr-1"></i> <strong>效期填寫：</strong> 僅救生員需填寫到期日，過期將不予採計。</p>
            </div>
        </div>

        <!-- 個人基本資料 -->
        <section class="glass-card p-8 shadow-sm mb-8">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 mb-1 tracking-widest uppercase">身分證字號</label>
                    <input type="text" id="idCard" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="E123456789">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 mb-1 tracking-widest uppercase">姓名</label>
                    <input type="text" id="name" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="請輸入全名">
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 mb-1 tracking-widest uppercase">主要隸屬</label>
                    <select id="bigBrigade" onchange="toggleUnitUI()" class="select-custom w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="">請選擇單位類型</option>
                        <option value="局本部">局本部 (科、室、中心)</option>
                        <option value="第一大隊">第一大隊</option>
                        <option value="第二大隊">第二大隊</option>
                        <option value="第三大隊">第三大隊</option>
                        <option value="第四大隊">第四大隊</option>
                    </select>
                </div>
            </div>

            <!-- 動態單位區域 -->
            <div id="unitSelectorArea" class="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-slate-100 hidden">
                <!-- 局本部輸入框 -->
                <div id="hqInputArea" class="md:col-span-2 hidden">
                    <label class="block text-[10px] font-black text-slate-400 mb-1 tracking-widest uppercase">所屬科、室、中心名稱</label>
                    <input type="text" id="hqDeptName" class="w-full bg-white border-2 border-blue-100 rounded-xl p-3 focus:border-blue-500 outline-none" placeholder="例如：人事室、火災調查科...">
                </div>
                <!-- 大隊選單 -->
                <div id="brigadeSelectArea" class="md:col-span-2 grid md:grid-cols-2 gap-6 hidden">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 mb-1 tracking-widest uppercase">中隊</label>
                        <select id="medBrigade" onchange="updateSmall()" class="select-custom w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 mb-1 tracking-widest uppercase">分隊 / 本部</label>
                        <select id="smallUnit" class="select-custom w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 outline-none"></select>
                    </div>
                </div>
            </div>
        </section>

        <!-- 證照申報區 -->
        <div id="mainForm" class="space-y-10">
            <!-- JS 動態渲染 -->
        </div>

        <!-- 送出按鈕 -->
        <div class="mt-16 mb-32 flex flex-col items-center">
            <button onclick="prepareConfirmation()" class="bg-slate-900 hover:bg-blue-600 text-white px-16 py-4 rounded-2xl font-black text-xl shadow-xl transition-all transform hover:-translate-y-1">
                預覽積分報告
            </button>
        </div>
    </div>

    <!-- 懸浮儀表板 -->
    <div class="fixed bottom-10 right-10 z-40 hidden md:block">
        <div class="bg-white p-6 rounded-3xl shadow-2xl border-t-4 border-blue-600 text-center min-w-[140px]">
            <p class="text-[10px] font-black text-slate-400 uppercase">Total Score</p>
            <span id="floatingScore" class="text-4xl font-black text-blue-600">0.00</span>
        </div>
    </div>

    <!-- 預覽彈窗 -->
    <div id="modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[2.5rem] shadow-2xl overflow-hidden">
            <div class="bg-slate-50 p-8 border-b text-center">
                <h3 class="text-2xl font-black text-slate-800 tracking-tighter italic">SCORE PREVIEW</h3>
                <p class="text-slate-400 text-xs mt-1 font-bold">請確認以下採計結果是否正確</p>
            </div>
            <div class="p-8">
                <div id="confirmList" class="space-y-3 mb-6"></div>
                <div class="flex justify-between items-center bg-blue-50 p-6 rounded-3xl mb-8">
                    <span class="font-bold text-slate-600">預計申報總積分：</span>
                    <span id="modalTotal" class="text-4xl font-black text-blue-600">0.00</span>
                </div>
                <div class="flex gap-4">
                    <button onclick="closeModal()" class="flex-1 py-4 font-bold text-slate-400 hover:bg-slate-100 rounded-2xl transition">返回修改</button>
                    <button id="finalSubmitBtn" onclick="submitToGas()" class="flex-1 py-4 bg-blue-600 text-white font-bold rounded-2xl hover:bg-blue-700 transition">確認送出</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const AUDIT_UNITS = {
            "第一大隊": {
                "本部": ["第一救災救護大隊"],
                "中正中隊": ["中正中隊", "華山分隊", "泉州分隊", "古亭分隊", "城中分隊"], 
                "萬華中隊": ["萬華中隊", "雙園分隊", "龍山分隊"],
                "文山中隊": ["文山中隊", "萬芳分隊", "景美分隊", "木柵分隊", "寶橋分隊"]
            },
            "第二大隊": {
                "本部": ["第二救災救護大隊"],
                "大安中隊": ["大安中隊", "金華分隊", "復興分隊", "安和分隊"],
                "信義中隊": ["信義中隊", "信義分隊", "莊敬分隊"], 
                "南港中隊": ["南港中隊", "南港分隊", "舊莊分隊", "成德分隊"]
            },
            "第三大隊": {
                "本部": ["第三救災救護大隊"],
                "中山中隊": ["中山中隊", "大直分隊", "圓山分隊", "松江分隊"], 
                "松山中隊": ["松山中隊", "中崙分隊", "八德分隊"],
                "內湖中隊": ["內湖中隊", "民權分隊", "內湖分隊", "大湖分隊", "東湖分隊"]
            },
            "第四大隊": {
                "本部": ["第四救災救護大隊"],
                "大同中隊": ["大同中隊", "建成分隊", "延平分隊", "大同分隊"],
                "士林中隊": ["士林中隊", "山仔后分隊", "天母分隊", "福安分隊", "社子分隊", "劍潭分隊", "雙溪分隊"], 
                "北投中隊": ["北投中隊", "陽明山分隊", "光明分隊", "關渡分隊", "石牌分隊", "秀山分隊"]
            }
        };

        const CONFIG = [
            { id: "water", title: "水上救生", items: [{ name: "救生員", score: 0.35, hasDate: true }, { name: "救生教練", score: 0.56, hasDate: false }] },
            { id: "swift", title: "急流救援", items: [{ name: "急流救援訓練(40H)", score: 0.56, hasDate: false }, { name: "急流教官班(45H)", score: 0.70, hasDate: false }] },
            { id: "dive", title: "潛水救援", items: [{ name: "救援潛水", score: 0.56, hasDate: false }, { name: "潛水教官", score: 0.70, hasDate: false }, { name: "公安潛水(82H)", score: 0.70, hasDate: false }] },
            { id: "drive", title: "車輛駕駛", items: [{ name: "大貨(客)車駕照", score: 0.70, hasDate: false }, { name: "聯結車駕照", score: 1.05, hasDate: false }] }
        ];

        // 單位切換 UI 邏輯
        function toggleUnitUI() {
            const val = document.getElementById('bigBrigade').value;
            const area = document.getElementById('unitSelectorArea');
            const hq = document.getElementById('hqInputArea');
            const brig = document.getElementById('brigadeSelectArea');

            if (!val) { area.classList.add('hidden'); return; }
            area.classList.remove('hidden');

            if (val === "局本部") {
                hq.classList.remove('hidden');
                brig.classList.add('hidden');
            } else {
                hq.classList.add('hidden');
                brig.classList.remove('hidden');
                updateMedium(val);
            }
        }

        function updateMedium(bigVal) {
            const med = document.getElementById('medBrigade');
            med.innerHTML = '<option value="">請選擇中隊</option>';
            document.getElementById('smallUnit').innerHTML = '<option value="">請選擇分隊</option>';
            for (let m in AUDIT_UNITS[bigVal]) {
                med.options.add(new Option(m, m));
            }
        }

        function updateSmall() {
            const bigVal = document.getElementById('bigBrigade').value;
            const medVal = document.getElementById('medBrigade').value;
            const small = document.getElementById('smallUnit');
            small.innerHTML = '<option value="">請選擇分隊</option>';
            if (AUDIT_UNITS[bigVal][medVal]) {
                AUDIT_UNITS[bigVal][medVal].forEach(u => small.options.add(new Option(u, u)));
            }
        }

        // 初始化申報表
        function initForm() {
            const container = document.getElementById('mainForm');
            CONFIG.forEach(cat => {
                let html = `
                    <div class="glass-card overflow-hidden shadow-sm border-b-4 border-slate-100">
                        <div class="bg-slate-50 px-8 py-4 border-b flex justify-between items-center">
                            <span class="font-black text-slate-400 text-[10px] tracking-widest uppercase">${cat.title}</span>
                            <span class="text-[10px] font-bold text-blue-500 uppercase">擇優取最高分</span>
                        </div>
                        <div class="p-6 space-y-4">
                            <!-- 無相關證照選項 -->
                            <div class="item-row p-4 rounded-2xl flex items-center gap-4 cursor-pointer hover:bg-slate-50 transition" onclick="handleNoCert('${cat.id}')">
                                <input type="checkbox" id="noCert_${cat.id}" class="w-6 h-6 rounded-lg no-cert-check" onchange="handleNoCert('${cat.id}')">
                                <div>
                                    <p class="font-bold text-slate-700">無相關證照 / 暫不申報</p>
                                    <p class="text-[10px] text-slate-400">本區積分將以 0.00 計算</p>
                                </div>
                            </div>
                `;
                cat.items.forEach(item => {
                    html += `
                        <div class="item-row p-5 rounded-3xl bg-white flex flex-col md:flex-row md:items-center justify-between gap-4 cert-item-${cat.id}" data-cat="${cat.id}" data-score="${item.score}" data-name="${item.name}">
                            <div class="flex items-center gap-4">
                                <input type="checkbox" onchange="handleCertCheck(this, '${cat.id}')" class="w-7 h-7 rounded-xl text-blue-600 cert-check focus:ring-0">
                                <div>
                                    <h4 class="font-bold text-slate-800">${item.name}</h4>
                                    <p class="text-blue-600 font-black text-xs">+ ${item.score.toFixed(2)} pts</p>
                                </div>
                            </div>
                            <div class="flex flex-wrap items-center gap-6">
                                <div class="flex flex-col min-w-[140px]">
                                    <span class="text-[10px] font-black text-slate-300 uppercase mb-1 underline">效期判定</span>
                                    ${item.hasDate ? `
                                        <div class="flex items-center gap-2">
                                            <input type="date" onchange="updateCalc()" class="cert-date border-2 border-slate-100 rounded-lg p-1 text-[10px] outline-none focus:border-blue-400">
                                            <label class="text-[10px] flex items-center gap-1 cursor-pointer"><input type="checkbox" onchange="toggleIndefinite(this)"> 永久</label>
                                        </div>` : `<span class="text-xs font-bold text-green-600">永久有效</span>`}
                                </div>
                                <div class="flex flex-col">
                                    <span class="text-[10px] font-black text-slate-300 uppercase mb-1">檔案</span>
                                    <input type="file" onchange="updateCalc()" class="cert-file text-[10px] w-32 text-slate-400 file:bg-slate-100 file:border-0 file:rounded-full file:px-3 file:py-1">
                                </div>
                            </div>
                        </div>
                    `;
                });
                container.innerHTML += html + `</div></div>`;
            });
        }

        // 邏輯控制：點擊「無證照」取消其他
        function handleNoCert(catId) {
            const noCertCheck = document.getElementById(`noCert_${catId}`);
            if (event.target.type !== 'checkbox') noCertCheck.checked = !noCertCheck.checked;
            
            if (noCertCheck.checked) {
                document.querySelectorAll(`.cert-item-${catId} .cert-check`).forEach(c => c.checked = false);
            }
            updateCalc();
        }

        // 邏輯控制：勾選證照時取消「無證照」
        function handleCertCheck(el, catId) {
            if (el.checked) document.getElementById(`noCert_${catId}`).checked = false;
            updateCalc();
        }

        function toggleIndefinite(el) {
            const dateInput = el.closest('.item-row').querySelector('.cert-date');
            dateInput.disabled = el.checked;
            if (el.checked) dateInput.value = "";
            updateCalc();
        }

        function updateCalc() {
            const today = new Date(); today.setHours(0,0,0,0);
            let total = 0;

            CONFIG.forEach(cat => {
                let catMax = 0; let winner = null;
                const rows = document.querySelectorAll(`.cert-item-${cat.id}`);
                const isNoCert = document.getElementById(`noCert_${cat.id}`).checked;

                if (!isNoCert) {
                    rows.forEach(row => {
                        const isChecked = row.querySelector('.cert-check').checked;
                        const dateInput = row.querySelector('.cert-date');
                        const isIndefinite = row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked;
                        row.classList.remove('highest-glow', 'opacity-30');

                        if (isChecked) {
                            let valid = true;
                            if (dateInput && !isIndefinite) {
                                if (!dateInput.value || new Date(dateInput.value) < today) valid = false;
                            }
                            if (valid && parseFloat(row.dataset.score) > catMax) {
                                catMax = parseFloat(row.dataset.score); winner = row;
                            }
                        }
                    });
                    if (winner) {
                        rows.forEach(r => { if(r === winner) r.classList.add('highest-glow'); else if(r.querySelector('.cert-check').checked) r.classList.add('opacity-30'); });
                    }
                } else {
                    rows.forEach(r => { r.classList.add('opacity-30'); r.classList.remove('highest-glow'); });
                }
                total += catMax;
            });
            document.getElementById('floatingScore').innerText = total.toFixed(2);
        }

        function prepareConfirmation() {
            const bigVal = document.getElementById('bigBrigade').value;
            const name = document.getElementById('name').value;
            if (!bigVal || !name) return alert("請填寫姓名與所屬單位！");

            const list = document.getElementById('confirmList'); list.innerHTML = "";
            let finalTotal = 0;
            CONFIG.forEach(cat => {
                let best = { name: "無相關證照", score: 0 };
                const isNoCert = document.getElementById(`noCert_${cat.id}`).checked;
                if (!isNoCert) {
                    document.querySelectorAll(`.cert-item-${cat.id}`).forEach(row => {
                        const isChecked = row.querySelector('.cert-check').checked;
                        const dateInput = row.querySelector('.cert-date');
                        const isIndefinite = row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked;
                        if (isChecked) {
                            let valid = true;
                            if (dateInput && !isIndefinite) {
                                if (!dateInput.value || new Date(dateInput.value) < new Date().setHours(0,0,0,0)) valid = false;
                            }
                            if (valid && parseFloat(row.dataset.score) > best.score) best = { name: row.dataset.name, score: parseFloat(row.dataset.score) };
                        }
                    });
                }
                list.innerHTML += `<div class="flex justify-between items-center p-4 bg-slate-50 rounded-2xl"><div><p class="text-[10px] font-black text-slate-300 uppercase">${cat.title}</p><p class="font-bold text-slate-700">${best.name}</p></div><p class="text-xl font-black text-blue-600">+${best.score.toFixed(2)}</p></div>`;
                finalTotal += best.score;
            });
            document.getElementById('modalTotal').innerText = finalTotal.toFixed(2);
            document.getElementById('modal').classList.remove('hidden');
        }

        function closeModal() { document.getElementById('modal').classList.add('hidden'); }

        async function submitToGas() {
            const btn = document.getElementById('finalSubmitBtn'); btn.disabled = true; btn.innerText = "傳送中...";
            const payload = {
                idCard: document.getElementById('idCard').value,
                name: document.getElementById('name').value,
                bigBrigade: document.getElementById('bigBrigade').value,
                hqDeptName: document.getElementById('hqDeptName').value,
                medBrigade: document.getElementById('medBrigade').value,
                smallUnit: document.getElementById('smallUnit').value,
                certificates: []
            };
            for (let check of document.querySelectorAll('.cert-check:checked')) {
                const row = check.closest('.item-row');
                const file = row.querySelector('.cert-file').files[0];
                payload.certificates.push({
                    category: row.dataset.cat, itemName: row.dataset.name, score: row.dataset.score,
                    expiry: row.querySelector('.cert-date')?.value || (row.querySelector('input[type="checkbox"]:not(.cert-check)')?.checked ? "永久" : "永久"),
                    fileBase64: file ? await toBase64(file) : null
                });
            }
            // 這裡發送 fetch 到你的 GAS URL
            console.log("Payload:", payload);
            alert("模擬送出成功！請至控制台查看資料結構。");
            btn.disabled = false; btn.innerText = "確認送出";
            closeModal();
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result.split(',')[1]);
            reader.onerror = reject;
        });

        initForm();
    </script>
</body>
</html>
